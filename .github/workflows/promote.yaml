name: Promote to Production

on:
    workflow_dispatch:
        inputs:
            image_tag:
                description: 'Image tag to promote (commit SHA from dev)'
                required: true
                type: string
            skip_verification:
                description: 'Skip image verification (not recommended)'
                required: false
                type: boolean
                default: false

env:
    DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/milk-pro
    GITOPS_REPO: ${{ github.repository_owner }}/GitOps-Repo
    APP_PATH: apps/milk-pro

jobs:
    # ==========================================
    # Verify Image Exists
    # ==========================================
    verify:
        name: Verify Image
        runs-on: ubuntu-latest
        if: ${{ !inputs.skip_verification }}

        steps:
            -   name: Login to Docker Hub
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKERHUB_USERNAME }}
                    password: ${{ secrets.DOCKERHUB_TOKEN }}

            -   name: Verify image exists
                run: |
                    echo "üîç Verifying image: ${{ env.DOCKER_IMAGE }}:${{ inputs.image_tag }}"
                    if docker manifest inspect ${{ env.DOCKER_IMAGE }}:${{ inputs.image_tag }} > /dev/null 2>&1; then
                      echo "‚úÖ Image found"
                    else
                      echo "‚ùå Image not found: ${{ env.DOCKER_IMAGE }}:${{ inputs.image_tag }}"
                      exit 1
                    fi

    # ==========================================
    # Promote to Production
    # ==========================================
    promote:
        name: Promote to Prod
        needs: verify
        if: always() && (needs.verify.result == 'success' || needs.verify.result == 'skipped')
        runs-on: ubuntu-latest
        environment: production

        steps:
            -   name: Setup SSH agent
                uses: webfactory/ssh-agent@v0.9.0
                with:
                    ssh-private-key: ${{ secrets.GITOPS_SSH_KEY }}

            -   name: Configure git
                run: |
                    git config --global user.name "github-actions[bot]"
                    git config --global user.email "github-actions[bot]@users.noreply.github.com"
                    mkdir -p ~/.ssh
                    ssh-keyscan github.com >> ~/.ssh/known_hosts

            -   name: Update prod manifest
                run: |
                    git clone git@github.com:${{ env.GITOPS_REPO }}.git gitops
                    cd gitops

                    # Update image tag
                    sed -i "s|newTag:.*|newTag: ${{ inputs.image_tag }}|g" ${{ env.APP_PATH }}/overlays/prod/kustomization.yaml

                    # Commit and push if changed
                    if [[ -n $(git status --porcelain) ]]; then
                      git add ${{ env.APP_PATH }}/overlays/prod/kustomization.yaml
                      git commit -m "deploy(prod): milk-pro @ ${{ inputs.image_tag }}"
                      git push
                      echo "‚úÖ Promoted to production: ${{ inputs.image_tag }}"
                    else
                      echo "‚ÑπÔ∏è Already at version ${{ inputs.image_tag }}"
                    fi

    # ==========================================
    # Tag as Stable
    # ==========================================
    tag-stable:
        name: Tag as Stable
        needs: promote
        runs-on: ubuntu-latest

        steps:
            -   name: Login to Docker Hub
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKERHUB_USERNAME }}
                    password: ${{ secrets.DOCKERHUB_TOKEN }}

            -   name: Tag image as stable
                run: |
                    docker pull ${{ env.DOCKER_IMAGE }}:${{ inputs.image_tag }}
                    docker tag ${{ env.DOCKER_IMAGE }}:${{ inputs.image_tag }} ${{ env.DOCKER_IMAGE }}:stable
                    docker push ${{ env.DOCKER_IMAGE }}:stable
                    echo "‚úÖ Tagged as stable: ${{ inputs.image_tag }}"

    # ==========================================
    # Create Release
    # ==========================================
    create-release:
        name: Create Release
        needs: [ promote, tag-stable ]
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v4
                with:
                    ref: ${{ inputs.image_tag }}

            -   name: Create GitHub Release
                uses: softprops/action-gh-release@v2
                with:
                    tag_name: release-${{ inputs.image_tag }}
                    name: Production Release ${{ inputs.image_tag }}
                    body: |
                        ## Production Deployment

                        **Image:** `${{ env.DOCKER_IMAGE }}:${{ inputs.image_tag }}`
                        **Deployed by:** @${{ github.actor }}
                        **Date:** ${{ github.event.repository.updated_at }}

                        ### Docker Tags
                        - `${{ inputs.image_tag }}`
                        - `stable`
                    draft: false
                    prerelease: false
