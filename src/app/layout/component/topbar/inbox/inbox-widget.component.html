<button type="button" class="layout-topbar-action" (click)="inboxPopover.toggle($event)">
    @if (pendingReceptions().length > 0) {
        <p-overlay-badge severity="danger">
            <i class="pi pi-inbox"></i>
        </p-overlay-badge>
    } @else {
        <i class="pi pi-inbox"></i>
    }
    <span>Приемная</span>
</button>

<p-popover #inboxPopover (onShow)="onPopoverShow()" [style]="{ width: '400px', maxHeight: '500px' }">
    <ng-template pTemplate="content">
        <div class="p-4 border-b border-surface">
            <div class="font-semibold text-lg">Ожидающие приемы</div>
            <div class="text-sm text-surface-500">Требуют рассмотрения</div>
        </div>

        <div class="overflow-y-auto" style="max-height: 400px;">
            @if (loading) {
                <div class="text-center p-8">
                    <i class="pi pi-spin pi-spinner text-xl"></i>
                </div>
            } @else if (pendingReceptions().length > 0) {
                @for (reception of pendingReceptions(); track reception.id) {
                    <div (click)="openReceptionDetails(reception.id); inboxPopover.toggle($event)"
                         class="p-4 border-b border-surface hover:bg-surface-50 dark:hover:bg-surface-800 cursor-pointer transition-colors">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold mb-1 text-ellipsis overflow-hidden whitespace-nowrap">
                                    {{ reception.name }}
                                </div>
                                <div class="text-sm text-surface-500 mb-2">
                                    <i class="pi pi-user text-xs mr-1"></i>
                                    {{ reception.visitor }}
                                </div>
                                @if (reception.together) {
                                    <div class="text-sm text-surface-500 mb-2">
                                        <i class="pi pi-users text-xs mr-1"></i>
                                        {{ reception.together }}
                                    </div>
                                }
                                <div class="flex items-center gap-2 text-xs text-surface-500">
                                    <i class="pi pi-calendar"></i>
                                    <span>{{ reception.date | date: 'dd.MM.yyyy' }}</span>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <p-tag
                                    [value]="getStatusLabel(reception)"
                                    [severity]="getStatusSeverity(reception)"
                                    [rounded]="true"
                                />
                            </div>
                        </div>
                        @if (reception.description) {
                            <div class="mt-2 text-sm text-surface-600 line-clamp-2">
                                {{ reception.description }}
                            </div>
                        }
                    </div>
                }
            } @else {
                <div class="text-center p-8 text-surface-500">
                    <i class="pi pi-inbox text-4xl mb-3 block"></i>
                    <div>Нет ожидающих приемов</div>
                </div>
            }
        </div>
    </ng-template>
</p-popover>

<p-dialog
    [(visible)]="receptionDialogVisible"
    [header]="receptionDialogHeader"
    [modal]="true"
    [style]="{ width: '600px' }"
    [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
>
    @if (loadingReceptionDetails) {
        <div class="flex items-center justify-center p-8">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>
    } @else if (selectedReceptionDetails) {
        <div class="flex flex-col gap-4">
            <div>
                <div class="font-semibold text-surface-500 mb-1">Название</div>
                <div class="text-lg">{{ selectedReceptionDetails.name }}</div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Дата</div>
                    <div class="flex items-center gap-2">
                        <i class="pi pi-calendar text-surface-500"></i>
                        <span>{{ selectedReceptionDetails.date | date: 'dd.MM.yyyy' }}</span>
                    </div>
                </div>

                <div>
                    <div class="font-semibold text-surface-500 mb-1">Статус</div>
                    <p-tag
                        [value]="getStatusLabel(selectedReceptionDetails)"
                        [severity]="getStatusSeverity(selectedReceptionDetails)"
                    />
                </div>
            </div>

            <div>
                <div class="font-semibold text-surface-500 mb-1">Посетитель</div>
                <div class="flex items-center gap-2">
                    <i class="pi pi-user text-surface-500"></i>
                    <span>{{ selectedReceptionDetails.visitor }}</span>
                </div>
            </div>

            @if (selectedReceptionDetails.together) {
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Совместно</div>
                    <div class="flex items-center gap-2">
                        <i class="pi pi-users text-surface-500"></i>
                        <span>{{ selectedReceptionDetails.together }}</span>
                    </div>
                </div>
            }

            @if (selectedReceptionDetails.description) {
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Описание</div>
                    <div class="whitespace-pre-wrap p-3 bg-surface-50 dark:bg-surface-800 rounded-border">
                        {{ selectedReceptionDetails.description }}
                    </div>
                </div>
            }

            @if (selectedReceptionDetails.status_change_reason) {
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Комментарий</div>
                    <div class="whitespace-pre-wrap p-3 bg-surface-50 dark:bg-surface-800 rounded-border">
                        {{ selectedReceptionDetails.status_change_reason }}
                    </div>
                </div>
            }

            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Создано</div>
                    <div class="text-surface-600">
                        {{ selectedReceptionDetails.created_at | date: 'dd.MM.yyyy HH:mm' }}
                    </div>
                    @if (selectedReceptionDetails.created_by) {
                        <div class="text-surface-500 text-xs mt-1">
                            {{ selectedReceptionDetails.created_by.name }}
                        </div>
                    }
                </div>

                @if (selectedReceptionDetails.updated_at) {
                    <div>
                        <div class="font-semibold text-surface-500 mb-1">Обновлено</div>
                        <div class="text-surface-600">
                            {{ selectedReceptionDetails.updated_at | date: 'dd.MM.yyyy HH:mm' }}
                        </div>
                        @if (selectedReceptionDetails.updated_by) {
                            <div class="text-surface-500 text-xs mt-1">
                                {{ selectedReceptionDetails.updated_by.name }}
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }

    <ng-template #footer>
        @if (selectedReceptionDetails && selectedReceptionDetails.status === 'default') {
            <div class="flex gap-2">
                <p-button
                    label="Одобрить"
                    icon="pi pi-check"
                    severity="success"
                    (onClick)="approveReception(selectedReceptionDetails)"
                />
                <p-button
                    label="Отклонить"
                    icon="pi pi-times"
                    severity="danger"
                    (onClick)="rejectReception(selectedReceptionDetails)"
                />
                <p-button
                    label="Перенести"
                    icon="pi pi-calendar"
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="openRescheduleDialog(selectedReceptionDetails)"
                />
            </div>
        }
    </ng-template>
</p-dialog>

<!-- Reject Dialog -->
<p-dialog
    [(visible)]="rejectDialogVisible"
    header="Отклонить прием"
    [modal]="true"
    [style]="{ width: '500px' }"
    [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
>
    <form [formGroup]="rejectForm" (ngSubmit)="saveRejection()">
        <div class="flex flex-col gap-4">
            @if (selectedReceptionForReject) {
                <div class="p-3 bg-surface-50 dark:bg-surface-800 rounded-border">
                    <div class="font-semibold mb-1">{{ selectedReceptionForReject.name }}</div>
                    <div class="text-sm text-surface-500">
                        Посетитель: {{ selectedReceptionForReject.visitor }}
                    </div>
                    @if (selectedReceptionForReject.together) {
                        <div class="text-sm text-surface-500">
                            Совместно: {{ selectedReceptionForReject.together }}
                        </div>
                    }
                    <div class="text-sm text-surface-500">
                        Дата: {{ selectedReceptionForReject.date | date: 'dd.MM.yyyy HH:mm' }}
                    </div>
                </div>
            }

            <app-textarea
                label="Причина отклонения"
                formControlName="reason"
                [submitted]="submittedReject"
                [required]="true"
                errorMessage="Укажите причину отклонения"
            />
        </div>
    </form>

    <ng-template #footer>
        <div class="flex gap-2">
            <p-button
                label="Отмена"
                icon="pi pi-times"
                severity="secondary"
                [outlined]="true"
                (onClick)="closeRejectDialog()"
            />
            <p-button
                label="Отклонить"
                icon="pi pi-check"
                severity="danger"
                (onClick)="saveRejection()"
            />
        </div>
    </ng-template>
</p-dialog>

<!-- Reschedule Dialog -->
<p-dialog
    [(visible)]="rescheduleDialogVisible"
    header="Перенести прием"
    [modal]="true"
    [style]="{ width: '500px' }"
    [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
>
    <form [formGroup]="rescheduleForm" (ngSubmit)="saveReschedule()">
        <div class="flex flex-col gap-4">
            @if (selectedReceptionForReschedule) {
                <div class="p-3 bg-surface-50 dark:bg-surface-800 rounded-border">
                    <div class="font-semibold mb-1">Текущий прием:</div>
                    <div class="text-sm">{{ selectedReceptionForReschedule.name }}</div>
                    <div class="text-sm text-surface-500">
                        Посетитель: {{ selectedReceptionForReschedule.visitor }}
                    </div>
                    @if (selectedReceptionForReschedule.together) {
                        <div class="text-sm text-surface-500">
                            Совместно: {{ selectedReceptionForReschedule.together }}
                        </div>
                    }
                    <div class="text-sm text-surface-500">
                        Текущая дата: {{ selectedReceptionForReschedule.date | date: 'dd.MM.yyyy HH:mm' }}
                    </div>
                </div>
            }

            <app-date-picker
                label="Новая дата и время"
                formControlName="date"
                [submitted]="submittedReschedule"
                [showTime]="true"
                [required]="true"
                errorMessage="Укажите новую дату и время"
            />

            <app-textarea
                label="Причина переноса"
                formControlName="reason"
                [submitted]="submittedReschedule"
                [required]="true"
                errorMessage="Укажите причину переноса"
            />
        </div>
    </form>

    <ng-template #footer>
        <div class="flex gap-2">
            <p-button
                label="Отмена"
                icon="pi pi-times"
                severity="secondary"
                [outlined]="true"
                (onClick)="closeRescheduleDialog()"
            />
            <p-button
                label="Сохранить"
                icon="pi pi-check"
                severity="primary"
                (onClick)="saveReschedule()"
            />
        </div>
    </ng-template>
</p-dialog>
