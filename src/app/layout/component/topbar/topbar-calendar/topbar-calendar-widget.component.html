<button type="button" class="layout-topbar-action" (click)="calendarPopover.toggle($event)">
    <i class="pi pi-calendar"></i>
    <span>Календарь</span>
</button>
<p-popover #calendarPopover [style]="{ width: '350px' }">
    <ng-template pTemplate="content">
        <p-date-picker [(ngModel)]="selectedDate" (onSelect)="onDateSelect($event)" (onMonthChange)="onMonthChange($event)" [inline]="true" fluid>
            <ng-template pTemplate="date" let-date>
                @let hasEvent = hasEvents(date.day, date.month, date.year);
                @let hasReception = hasReceptions(date.day, date.month, date.year);
                <span
                    [ngClass]="{
                        'bg-primary text-primary-contrast': hasEvent && !hasReception,
                        'bg-green-500 text-white': !hasEvent && hasReception,
                        'bg-gradient-to-br from-primary to-green-500 text-white': hasEvent && hasReception
                    }"
                    [class.rounded-full]="hasEvent || hasReception"
                    [class.!w-8]="hasEvent || hasReception"
                    [class.!h-8]="hasEvent || hasReception"
                    [class.flex]="hasEvent || hasReception"
                    [class.items-center]="hasEvent || hasReception"
                    [class.justify-center]="hasEvent || hasReception">{{ date.day }}</span>
            </ng-template>
        </p-date-picker>
        <div class="p-4 border-t border-surface">
            <div class="font-semibold mb-2">
                События на {{ selectedDate | date: 'dd.MM.yyyy' }}:
            </div>
            @if (loading) {
                <div class="text-center p-4">
                    <i class="pi pi-spin pi-spinner text-xl"></i>
                </div>
            } @else if (selectedDayEvents().length > 0) {
                @for (event of selectedDayEvents(); track event.id) {
                    <div (click)="openEventDetails(event.id); calendarPopover.toggle($event)"
                         class="mb-2 flex items-center justify-between gap-2 cursor-pointer hover:bg-primary-50 dark:hover:bg-primary-950 p-2 rounded-border transition-colors">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-ellipsis overflow-hidden whitespace-nowrap">
                                {{ event.name }} ({{ event.event_date | date: 'HH:mm' }})
                            </div>
                            @if (event.event_type) {
                                <div class="text-xs text-surface-500">{{ event.event_type.name || '' }}</div>
                            }
                        </div>
                        <button pButton
                                type="button"
                                class="p-button-text p-button-rounded p-button-sm"
                                (click)="openEventDetails(event.id); $event.stopPropagation()"
                                pTooltip="Подробнее"
                                tooltipPosition="left">
                            <i class="pi pi-info-circle" pButtonIcon></i>
                        </button>
                    </div>
                }
            } @else if (selectedDayReceptions().length === 0) {
                <div>Нет событий</div>
            }

            @if (selectedDayReceptions().length > 0) {
                @if (selectedDayEvents().length > 0) {
                    <div class="my-3 border-t border-surface"></div>
                }
                <div class="font-semibold mb-2 text-green-600 dark:text-green-400">
                    Приемы:
                </div>
                @for (reception of selectedDayReceptions(); track reception.id) {
                    <div (click)="openReceptionDetails(reception.id); calendarPopover.toggle($event)"
                         class="mb-2 flex items-center justify-between gap-2 cursor-pointer hover:bg-green-50 dark:hover:bg-green-950 p-2 rounded-border transition-colors">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-ellipsis overflow-hidden whitespace-nowrap">
                                {{ reception.name }} ({{ reception.date | date: 'HH:mm' }})
                            </div>
                            <div class="text-xs text-surface-500">
                                Посетитель: {{ reception.visitor }}
                            </div>
                        </div>
                        <button pButton
                                type="button"
                                class="p-button-text p-button-rounded p-button-sm"
                                (click)="openReceptionDetails(reception.id); $event.stopPropagation()"
                                pTooltip="Подробнее"
                                tooltipPosition="left">
                            <i class="pi pi-info-circle" pButtonIcon></i>
                        </button>
                    </div>
                }
            }

            @if (selectedDayCounts()) {
                <div class="mt-3 pt-3 border-t border-surface">
                    <div class="flex flex-col gap-1 text-sm">
                        <div
                            (click)="onStatisticClick('incidents', selectedDayCounts()!.incidents); calendarPopover.hide()"
                            class="flex justify-between p-2 rounded-border transition-colors"
                            [ngClass]="selectedDayCounts()!.incidents > 0 ? 'cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800' : 'opacity-60'">
                            <span>Инциденты:</span>
                            <span class="font-medium">{{ selectedDayCounts()!.incidents }}</span>
                        </div>
                        <div
                            (click)="onStatisticClick('shutdowns', selectedDayCounts()!.shutdowns); calendarPopover.hide()"
                            class="flex justify-between p-2 rounded-border transition-colors"
                            [ngClass]="selectedDayCounts()!.shutdowns > 0 ? 'cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800' : 'opacity-60'">
                            <span>Аварийные отключения:</span>
                            <span class="font-medium">{{ selectedDayCounts()!.shutdowns }}</span>
                        </div>
                        <div
                            (click)="onStatisticClick('discharges', selectedDayCounts()!.discharges); calendarPopover.hide()"
                            class="flex justify-between p-2 rounded-border transition-colors"
                            [ngClass]="selectedDayCounts()!.discharges > 0 ? 'cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800' : 'opacity-60'">
                            <span>Холостые водосбросы:</span>
                            <span class="font-medium">{{ selectedDayCounts()!.discharges }}</span>
                        </div>
                        <div
                            (click)="onStatisticClick('visits', selectedDayCounts()!.visits); calendarPopover.hide()"
                            class="flex justify-between p-2 rounded-border transition-colors"
                            [ngClass]="selectedDayCounts()!.visits > 0 ? 'cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800' : 'opacity-60'">
                            <span>Визиты:</span>
                            <span class="font-medium">{{ selectedDayCounts()!.visits }}</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </ng-template>
</p-popover>

<p-dialog [(visible)]="eventDialogVisible" [header]="eventDialogHeader" [modal]="true" [style]="{ width: '600px' }"
          [breakpoints]="{ '960px': '75vw', '640px': '90vw' }">
    @if (loadingEventDetails) {
        <div class="flex items-center justify-center p-8">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>
    } @else if (selectedEventDetails) {
        <div class="flex flex-col gap-4">
            <div>
                <div class="font-semibold text-surface-500 mb-1">Название</div>
                <div>{{ selectedEventDetails.name }}</div>
            </div>

            @if (selectedEventDetails.description) {
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Описание</div>
                    <div class="whitespace-pre-wrap">{{ selectedEventDetails.description }}</div>
                </div>
            }

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Дата и время</div>
                    <div>{{ selectedEventDetails.event_date | date: 'dd.MM.yyyy HH:mm' }}</div>
                </div>

                @if (selectedEventDetails.event_type) {
                    <div>
                        <div class="font-semibold text-surface-500 mb-1">Тип</div>
                        <div>{{ selectedEventDetails.event_type.name }}</div>
                    </div>
                }
            </div>

            <div class="grid grid-cols-2 gap-4">
                @if (selectedEventDetails.location || selectedEventDetails.organization) {
                    <div>
                        <div class="font-semibold text-surface-500 mb-1">Место</div>
                        <div>{{ getLocationDisplay(selectedEventDetails) }}</div>
                    </div>
                }

                @if (selectedEventDetails.event_status) {
                    <div>
                        <div class="font-semibold text-surface-500 mb-1">Статус</div>
                        <div>{{ selectedEventDetails.event_status.name }}</div>
                    </div>
                }
            </div>

            @if (selectedEventDetails.responsible_contact) {
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Ответственный</div>
                    <div class="flex items-center gap-2">
                        <span>{{ selectedEventDetails.responsible_contact.name }}</span>
                        @if (selectedEventDetails.responsible_contact.phone) {
                            <a [href]="'tel:' + selectedEventDetails.responsible_contact.phone"
                               class="text-primary hover:underline">
                                {{ selectedEventDetails.responsible_contact.phone }}
                            </a>
                        }
                    </div>
                </div>
            }

            @if (selectedEventDetails.files && selectedEventDetails.files.length > 0) {
                <div>
                    <div class="font-semibold text-surface-500 mb-2">Файлы ({{ selectedEventDetails.files.length }})
                    </div>
                    <div class="flex flex-col gap-2">
                        @for (file of selectedEventDetails.files; track file.id) {
                            <a [href]="file.url" target="_blank" rel="noopener noreferrer"
                               class="flex items-center gap-3 p-3 rounded-border border border-surface transition-colors hover:bg-surface-50 dark:hover:bg-surface-800">
                                <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center">
                                    @if (isImageFile(file.file_name)) {
                                        <img [src]="file.url" [alt]="file.file_name"
                                             class="w-10 h-10 rounded object-contain" />
                                    } @else if (isVideoFile(file.file_name)) {
                                        <video [src]="file.url" class="w-10 h-10 rounded object-cover"
                                               muted></video>
                                    } @else {
                                        <i [class]="getFileIcon(file.file_name)" class="text-2xl"></i>
                                    }
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-ellipsis whitespace-nowrap overflow-hidden">
                                        {{ file.file_name }}
                                    </div>
                                    @if (file.size_bytes) {
                                        <div class="text-sm text-surface-500">{{ formatFileSize(file.size_bytes) }}
                                        </div>
                                    }
                                </div>
                                <i class="pi pi-external-link text-primary-500"></i>
                            </a>
                        }
                    </div>
                </div>
            }
        </div>
    }
</p-dialog>

<p-dialog [(visible)]="statisticsDialogVisible" [header]="statisticsDialogHeader" [modal]="true"
          [dismissableMask]="true" [style]="{ width: '700px' }" [breakpoints]="{ '960px': '85vw', '640px': '95vw' }">
    @if (loadingStatistics) {
        <div class="flex items-center justify-center p-8">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>
    } @else if (statisticsPastEvents().length > 0) {
        <div class="flex flex-col gap-3">
            @for (event of statisticsPastEvents(); track $index) {
                <div class="p-4 border border-surface rounded-border hover:bg-surface-50 dark:hover:bg-surface-900 transition-colors">
                    <div class="flex items-start gap-3">
                        <!-- Цветной индикатор типа -->
                        <div class="flex-shrink-0 mt-1">
                            @switch (event.type) {
                                @case ('danger') {
                                    <i class="pi pi-exclamation-circle text-red-500 text-xl"></i>
                                }
                                @case ('warning') {
                                    <i class="pi pi-exclamation-triangle text-yellow-500 text-xl"></i>
                                }
                                @case ('info') {
                                    <i class="pi pi-info-circle text-blue-500 text-xl"></i>
                                }
                                @case ('success') {
                                    <i class="pi pi-check-circle text-green-500 text-xl"></i>
                                }
                            }
                        </div>

                        <!-- Контент события -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-2 mb-2">
                                <div class="flex-1">
                                    @if (event.organization_name) {
                                        <div class="font-semibold text-lg mb-1">{{ event.organization_name }}</div>
                                    }
                                    <div class="text-sm text-surface-500">
                                        {{ event.date | date: 'dd.MM.yyyy HH:mm' }}
                                    </div>
                                </div>
                                @if (event.entity_type) {
                                    <span class="px-2 py-1 text-xs font-medium rounded bg-primary-100 text-primary-700 dark:bg-primary-900 dark:text-primary-300">
                                        {{ event.entity_type }}
                                    </span>
                                }
                            </div>

                            @if (event.description) {
                                <div class="text-surface-700 dark:text-surface-300 whitespace-pre-wrap mb-3">
                                    {{ event.description }}
                                </div>
                            }

                            <!-- Файлы если есть -->
                            @if (event.files && event.files.length > 0) {
                                <div class="mt-3 pt-3 border-t border-surface">
                                    <div class="text-xs font-semibold text-surface-500 mb-2">
                                        Файлы ({{ event.files.length }})
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        @for (file of event.files; track file.id) {
                                            <a [href]="file.url" target="_blank" rel="noopener noreferrer"
                                               class="inline-flex items-center gap-2 px-3 py-2 text-xs rounded-border border border-surface hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors">
                                                @if (isImageFile(file.file_name)) {
                                                    <img [src]="file.url" [alt]="file.file_name"
                                                         class="w-6 h-6 rounded object-cover" />
                                                } @else {
                                                    <i [class]="getFileIcon(file.file_name)" class="text-base"></i>
                                                }
                                                <span class="max-w-[200px] truncate">{{ file.file_name }}</span>
                                                @if (file.size_bytes) {
                                                    <span class="text-surface-400">({{ formatFileSize(file.size_bytes) }})</span>
                                                }
                                            </a>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    } @else {
        <div class="text-center p-8 text-surface-500">
            Нет данных для отображения
        </div>
    }
</p-dialog>

<p-dialog [(visible)]="receptionDialogVisible" [header]="receptionDialogHeader" [modal]="true"
          [dismissableMask]="true" [style]="{ width: '600px' }" [breakpoints]="{ '960px': '75vw', '640px': '90vw' }">
    @if (loadingReceptionDetails) {
        <div class="flex items-center justify-center p-8">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>
    } @else if (selectedReceptionDetails) {
        <div class="flex flex-col gap-4">
            <div>
                <div class="font-semibold text-surface-500 mb-1">Название</div>
                <div>{{ selectedReceptionDetails.name }}</div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Дата и время</div>
                    <div>{{ selectedReceptionDetails.date | date: 'dd.MM.yyyy HH:mm' }}</div>
                </div>

                <div>
                    <div class="font-semibold text-surface-500 mb-1">Статус</div>
                    <div>
                        @switch (selectedReceptionDetails.status) {
                            @case ('true') {
                                <span class="px-2 py-1 text-xs font-medium rounded bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300">
                                    Состоялся
                                </span>
                            }
                            @case ('false') {
                                <span class="px-2 py-1 text-xs font-medium rounded bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300">
                                    Не состоялся
                                </span>
                            }
                            @case ('default') {
                                <span class="px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-300">
                                    Запланирован
                                </span>
                            }
                        }
                    </div>
                </div>
            </div>

            <div>
                <div class="font-semibold text-surface-500 mb-1">Посетитель</div>
                <div>{{ selectedReceptionDetails.visitor }}</div>
            </div>

            @if (selectedReceptionDetails.together) {
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Сопровождающие</div>
                    <div>{{ selectedReceptionDetails.together }}</div>
                </div>
            }

            @if (selectedReceptionDetails.description) {
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Описание</div>
                    <div class="whitespace-pre-wrap">{{ selectedReceptionDetails.description }}</div>
                </div>
            }

            @if (selectedReceptionDetails.status_change_reason) {
                <div>
                    <div class="font-semibold text-surface-500 mb-1">Причина изменения статуса</div>
                    <div class="whitespace-pre-wrap">{{ selectedReceptionDetails.status_change_reason }}</div>
                </div>
            }

            <div class="grid grid-cols-2 gap-4">
                @if (selectedReceptionDetails.informed !== undefined) {
                    <div>
                        <div class="font-semibold text-surface-500 mb-1">Информирование</div>
                        <div>
                            @if (selectedReceptionDetails.informed) {
                                <span class="text-green-600 dark:text-green-400">
                                    <i class="pi pi-check-circle mr-1"></i>Проинформирован
                                </span>
                            } @else {
                                <span class="text-red-600 dark:text-red-400">
                                    <i class="pi pi-times-circle mr-1"></i>Не проинформирован
                                </span>
                            }
                        </div>
                    </div>
                }

                @if (selectedReceptionDetails.informed_by) {
                    <div>
                        <div class="font-semibold text-surface-500 mb-1">Проинформировал</div>
                        <div>{{ selectedReceptionDetails.informed_by.name }}</div>
                    </div>
                }
            </div>

            <div class="pt-3 border-t border-surface">
                <div class="grid grid-cols-2 gap-4 text-sm text-surface-500">
                    @if (selectedReceptionDetails.created_by) {
                        <div>
                            <div class="font-semibold mb-1">Создал</div>
                            <div>{{ selectedReceptionDetails.created_by.name }}</div>
                            <div class="text-xs">{{ selectedReceptionDetails.created_at | date: 'dd.MM.yyyy HH:mm' }}</div>
                        </div>
                    }

                    @if (selectedReceptionDetails.updated_by) {
                        <div>
                            <div class="font-semibold mb-1">Обновил</div>
                            <div>{{ selectedReceptionDetails.updated_by.name }}</div>
                            <div class="text-xs">{{ selectedReceptionDetails.updated_at | date: 'dd.MM.yyyy HH:mm' }}</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</p-dialog>
