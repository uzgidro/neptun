<div class="card mb-0 cursor-pointer" (click)="openDialog()">
    <div class="flex justify-between items-center mb-2">
        <span class="text-muted-color font-medium">{{ 'DASHBOARD.DEBIT' | translate }}</span>
        <div class="flex items-center gap-2">
            <button pButton type="button" icon="pi pi-dollar"
                    class="p-button-text p-button-plain p-button-rounded"
                    (click)="toggleCurrency(); $event.stopPropagation()"></button>
            <div class="flex items-center justify-center bg-green-100 dark:bg-green-400/10 rounded-border"
                 style="width: 2.5rem; height: 2.5rem">
                <i class="pi pi-wallet text-green-500 text-xl!"></i>
            </div>
        </div>
    </div>
    <div class="text-surface-900 dark:text-surface-0 font-medium text-xl mb-1">
        {{ displayValue | number: '1.0-0' }} {{ showInUSD ? '$' : 'UZS' }}
    </div>
    <div class="flex gap-1.5">
        <span class="text-primary font-medium">
            {{ dc?.debit?.diff && dc?.debit?.diff! > 0 ? '+' : '' }}{{ dc?.debit?.diff ?? 0 | number: '1.0-0' }}%
        </span>
        <span class="text-muted-color">{{ 'COMMON.SINCE_YEAR_START' | translate }}</span>
    </div>
</div>

<app-dialog
    [header]="('DASHBOARD.DEBIT_FOR' | translate) + ' ' + (dc?.currentDate | date:'dd.MM.yyyy')"
    [(visible)]="showDialog"
    [width]="'70vw'"
    [showFooter]="false"
    [showConvertButton]="true"
    [convertLabel]="convertButtonLabel"
    (convert)="toggleDialogCurrency()">
    <p-table [value]="dc?.items || []" dataKey="name" rowGroupMode="subheader" groupRowsBy="name">
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 3rem"></th>
                <th style="width: 40%">{{ 'COMMON.NAME' | translate }}</th>
                <th class="text-right" style="width: 20%">{{ 'COMMON.YEAR_START' | translate }}</th>
                <th class="text-right" style="width: 20%">{{ 'COMMON.CURRENT_VALUE' | translate }}</th>
                <th class="text-right" style="width: 20%">{{ 'COMMON.CHANGE' | translate }}</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="groupheader" let-item let-expanded="expanded">
            <tr>
                <td>
                    @if (item.items && item.items.length > 0) {
                        <button type="button" pButton pRipple [pRowToggler]="item"
                                class="p-button-text p-button-rounded p-button-plain"
                                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                    }
                </td>
                <td>{{ item.name }}</td>
                <td class="text-right">{{ convertValue(item.debit.yearStartValue) | number: '1.0-1' }}
                    млн {{ dialogShowInUSD ? '$' : 'UZS' }}
                </td>
                <td class="text-right font-semibold">{{ convertValue(item.debit.currentValue) | number: '1.0-1' }}
                    млн {{ dialogShowInUSD ? '$' : 'UZS' }}
                </td>
                <td class="text-right">
                    <span [class]="item.debit.diff > 0 ? 'text-green-500' : item.debit.diff < 0 ? 'text-red-500' : ''">
                        {{ item.debit.diff > 0 ? '+' : '' }}{{ item.debit.diff | number: '1.0-0' }}%
                    </span>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="expandedrow" let-item>
            <tr>
                <td colspan="5">
                    <div class="">
                        <p-table [value]="item.items || []" dataKey="name">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th style="width: 3rem"></th>
                                    <th style="width: 40%">{{ 'COMMON.SUBCATEGORY' | translate }}</th>
                                    <th class="text-right" style="width: 20%">{{ 'COMMON.YEAR_START' | translate }}</th>
                                    <th class="text-right" style="width: 20%">{{ 'COMMON.CURRENT_VALUE' | translate }}</th>
                                    <th class="text-right" style="width: 20%">{{ 'COMMON.CHANGE' | translate }}</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-subItem>
                                <tr>
                                    <td></td>
                                    <td>{{ subItem.name }}</td>
                                    <td class="text-right">{{ convertValue(subItem.debit.yearStartValue) | number: '1.0-1' }}
                                        млн {{ dialogShowInUSD ? '$' : 'UZS' }}
                                    </td>
                                    <td class="text-right font-semibold">{{ convertValue(subItem.debit.currentValue) | number: '1.0-1' }}
                                        млн {{ dialogShowInUSD ? '$' : 'UZS' }}
                                    </td>
                                    <td class="text-right">
                                        <span
                                            [class]="subItem.debit.diff > 0 ? 'text-green-500' : subItem.debit.diff < 0 ? 'text-red-500' : ''">
                                            {{ subItem.debit.diff > 0 ? '+' : '' }}{{ subItem.debit.diff | number: '1.0-0' }}
                                            %
                                        </span>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</app-dialog>
