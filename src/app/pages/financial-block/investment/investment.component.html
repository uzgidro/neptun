<div class="dashboard">

    <!-- HEADER -->
    <div class="dashboard-header">
        <h2>{{ 'FINANCIAL_BLOCK.INVESTMENT.TITLE' | translate }}</h2>
    </div>

    <!-- KPI -->
    <div class="kpi-row">
        <div class="kpi-card neutral">
            <span>{{ 'FINANCIAL_BLOCK.INVESTMENT.TOTAL_PROJECTS' | translate }}</span>
            <strong>{{ filteredInvestments.length }}</strong>
        </div>
        <div class="kpi-card success">
            <span>{{ 'FINANCIAL_BLOCK.INVESTMENT.ACTIVE_PHASE' | translate }}</span>
            <strong>{{ activePhaseCount }}</strong>
        </div>
        <div class="kpi-card warning">
            <span>{{ 'FINANCIAL_BLOCK.INVESTMENT.IN_DEVELOPMENT' | translate }}</span>
            <strong>{{ inDevelopmentCount }}</strong>
        </div>
        <div class="kpi-card balance">
            <span>{{ 'FINANCIAL_BLOCK.INVESTMENT.TOTAL_COST' | translate }}</span>
            <strong>{{ totalAmount | number }} UZS</strong>
        </div>
    </div>

    <!-- ADD BUTTON & DATE RANGE -->
    <div class="action-row mb-6">
        <p-button [label]="'FINANCIAL_BLOCK.INVESTMENT.ADD_PROJECT' | translate" icon="pi pi-plus"
                  (click)="openNew()" />

        <p-datepicker
            [(ngModel)]="dateRange"
            selectionMode="range"
            [showIcon]="true"
            [showButtonBar]="true"
            dateFormat="dd.mm.yy"
            [placeholder]="'FINANCIAL_BLOCK.COMMON.SELECT_DATE_RANGE' | translate"
            (onSelect)="onDateRangeChange()"
            (onClear)="onDateRangeClear()"
            appendTo="body"
            styleClass="w-72">
        </p-datepicker>
    </div>

    <!-- TABLE -->
    <div class="table-card">
        <p-table
            [value]="filteredInvestments"
            dataKey="id"
            stripedRows
            [scrollable]="true"
            scrollHeight="60rem"
            [tableStyle]="{ 'min-width': '70rem' }"
            [sortField]="'date'"
            [sortOrder]="-1">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="project_name">
                        {{ 'FINANCIAL_BLOCK.INVESTMENT.PROJECT_NAME' | translate }}
                        <p-sortIcon field="project_name"></p-sortIcon>
                    </th>
                    <th pSortableColumn="status">
                        {{ 'FINANCIAL_BLOCK.COMMON.STATUS' | translate }}
                        <p-sortIcon field="status"></p-sortIcon>
                    </th>
                    <th pSortableColumn="amount">
                        {{ 'FINANCIAL_BLOCK.INVESTMENT.AMOUNT' | translate }}
                        <p-sortIcon field="amount"></p-sortIcon>
                    </th>
                    <th pSortableColumn="date">
                        {{ 'FINANCIAL_BLOCK.COMMON.DATE' | translate }}
                        <p-sortIcon field="date"></p-sortIcon>
                    </th>
                    <th style="width: 10%">{{ 'FINANCIAL_BLOCK.COMMON.FILES' | translate }}</th>
                    <th>{{ 'FINANCIAL_BLOCK.COMMON.COMMENT' | translate }}</th>
                    <th style="width: 10%">{{ 'FINANCIAL_BLOCK.COMMON.ACTIONS' | translate }}</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-investment>
                <tr>
                    <td>{{ investment.project_name }}</td>
                    <td>
                        <span [class]="investment.status === 'Активная фаза' ? 'text-green-500' : 'text-orange-500'">
                            {{ investment.status === 'Активная фаза'
                                ? ('FINANCIAL_BLOCK.INVESTMENT.ACTIVE_PHASE' | translate)
                                : ('FINANCIAL_BLOCK.INVESTMENT.IN_DEVELOPMENT' | translate) }}
                        </span>
                    </td>
                    <td>{{ investment.amount | number }} UZS</td>
                    <td>{{ investment.date | date:'dd.MM.yyyy' }}</td>
                    <td>
                        @if (investment.files && investment.files.length > 0) {
                            <p-button
                                [label]="investment.files.length.toString()"
                                icon="pi pi-paperclip"
                                severity="secondary"
                                [text]="true"
                                (click)="showFiles(investment)"
                                [pTooltip]="'FINANCIAL_BLOCK.COMMON.FILES' | translate"
                            />
                        } @else {
                            <span class="text-color-secondary">—</span>
                        }
                    </td>
                    <td>{{ investment.comment }}</td>
                    <td>
                        <p-button
                            icon="pi pi-pencil"
                            severity="info"
                            [text]="true"
                            [rounded]="true"
                            (click)="editInvestment(investment)"
                            [pTooltip]="'FINANCIAL_BLOCK.COMMON.EDIT' | translate"
                        />
                        <p-button
                            icon="pi pi-trash"
                            severity="danger"
                            [text]="true"
                            [rounded]="true"
                            (click)="deleteInvestment(investment.id)"
                            [pTooltip]="'FINANCIAL_BLOCK.COMMON.DELETE' | translate"
                        />
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7" class="text-center">
                        {{ 'FINANCIAL_BLOCK.COMMON.NO_DATA' | translate }}
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

</div>

<!-- DIALOG FOR ADD/EDIT -->
<app-dialog
    [(visible)]="isFormOpen"
    [header]="isEditMode ? ('FINANCIAL_BLOCK.COMMON.EDIT' | translate) : ('FINANCIAL_BLOCK.INVESTMENT.ADD_PROJECT' | translate)"
    [form]="form"
    [submitting]="isLoading"
    (save)="onSubmit()"
    (cancel)="closeDialog()">

    <form class="p-4" [formGroup]="form" (ngSubmit)="onSubmit()">

        <app-input-text
            [label]="'FINANCIAL_BLOCK.INVESTMENT.PROJECT_NAME' | translate"
            formControlName="project_name"
            [submitted]="submitted"
            [required]="false">
        </app-input-text>

        <app-select
            [label]="'FINANCIAL_BLOCK.COMMON.STATUS' | translate"
            formControlName="status"
            [items]="statusOptions"
            [submitted]="submitted"
            [required]="false">
        </app-select>

        <app-input-number
            [label]="'FINANCIAL_BLOCK.INVESTMENT.AMOUNT' | translate"
            formControlName="amount"
            [submitted]="submitted"
            [required]="false">
        </app-input-number>

        <app-date-picker
            [label]="'FINANCIAL_BLOCK.COMMON.DATE' | translate"
            formControlName="date"
            [submitted]="submitted"
            [required]="false">
        </app-date-picker>

        <app-textarea
            [label]="'FINANCIAL_BLOCK.COMMON.COMMENT' | translate"
            formControlName="comment"
            [submitted]="submitted"
            [required]="false">
        </app-textarea>

        @if (isEditMode && currentInvestment?.files && (currentInvestment?.files?.length ?? 0) > 0) {
            <app-file-list
                [files]="currentInvestment?.files || []"
                (removeFile)="removeExistingFile($event)">
            </app-file-list>
        }

        <app-file-upload
            [label]="isEditMode ? ('FINANCIAL_BLOCK.COMMON.ADD' | translate) : ('FINANCIAL_BLOCK.COMMON.FILES' | translate)"
            [files]="selectedFiles"
            (filesChange)="onFileSelect($event)"
            (removeFile)="removeFile($event)">
        </app-file-upload>

    </form>

</app-dialog>

<!-- FILE VIEWER DIALOG -->
<app-file-viewer
    [(visible)]="showFilesDialog"
    [header]="'FINANCIAL_BLOCK.COMMON.FILES' | translate"
    [files]="selectedInvestmentForFiles?.files || []">
</app-file-viewer>
