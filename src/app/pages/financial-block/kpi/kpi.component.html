<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="kpi-container">
    <!-- Summary Cards Row -->
    <div class="summary-cards-row">
        <!-- Overall KPI Gauge -->
        <div class="summary-card gauge-card">
            <div class="card-content-gauge">
                <p-knob
                    [(ngModel)]="overallKpi"
                    [size]="140"
                    [readonly]="true"
                    [strokeWidth]="8"
                    valueTemplate="{value}%"
                    [valueColor]="getOverallKpiColor()"
                    rangeColor="#e5e7eb"
                ></p-knob>
                <span class="gauge-label">Общий KPI</span>
            </div>
        </div>

        <div class="summary-card achieved-card">
            <div class="card-content">
                <div class="card-icon achieved-icon">
                    <i class="pi pi-check-circle"></i>
                </div>
                <div class="card-info">
                    <span class="card-label">Выполнено</span>
                    <span class="card-value text-green-500">{{ achievedCount }}</span>
                </div>
            </div>
        </div>

        <div class="summary-card warning-card">
            <div class="card-content">
                <div class="card-icon warning-icon">
                    <i class="pi pi-exclamation-triangle"></i>
                </div>
                <div class="card-info">
                    <span class="card-label">Внимание</span>
                    <span class="card-value text-orange-500">{{ warningCount }}</span>
                </div>
            </div>
        </div>

        <div class="summary-card critical-card">
            <div class="card-content">
                <div class="card-icon critical-icon">
                    <i class="pi pi-times-circle"></i>
                </div>
                <div class="card-info">
                    <span class="card-label">Критично</span>
                    <span class="card-value text-red-500">{{ criticalCount }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Line Chart - KPI Trend -->
        <div class="chart-card chart-large">
            <div class="chart-header">
                <h3>Динамика общего KPI</h3>
                <span class="chart-icon"><i class="pi pi-chart-line"></i></span>
            </div>
            <div class="chart-body">
                <p-chart
                    type="line"
                    [data]="lineChartData"
                    [options]="lineChartOptions"
                ></p-chart>
            </div>
        </div>

        <!-- Right side charts -->
        <div class="charts-right">
            <!-- Radar Chart -->
            <div class="chart-card chart-small">
                <div class="chart-header">
                    <h3>KPI по категориям</h3>
                    <span class="chart-icon"><i class="pi pi-chart-pie"></i></span>
                </div>
                <div class="chart-body-small">
                    <p-chart
                        type="radar"
                        [data]="radarChartData"
                        [options]="radarChartOptions"
                    ></p-chart>
                </div>
            </div>

            <!-- Status Chart -->
            <div class="chart-card chart-small">
                <div class="chart-header">
                    <h3>Распределение статусов</h3>
                    <span class="chart-icon"><i class="pi pi-percentage"></i></span>
                </div>
                <div class="chart-body-small">
                    <p-chart
                        type="doughnut"
                        [data]="statusChartData"
                        [options]="statusChartOptions"
                    ></p-chart>
                </div>
            </div>
        </div>
    </div>

    <!-- Bar Chart Section -->
    <div class="bar-chart-section">
        <div class="chart-card">
            <div class="chart-header">
                <h3>План vs Факт (топ показатели)</h3>
                <span class="chart-icon"><i class="pi pi-chart-bar"></i></span>
            </div>
            <div class="chart-body-bar">
                <p-chart
                    type="bar"
                    [data]="barChartData"
                    [options]="barChartOptions"
                ></p-chart>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar-card">
        <div class="toolbar-filters">
            <!-- Search -->
            <p-inputGroup class="search-input">
                <p-inputGroupAddon>
                    <i class="pi pi-search"></i>
                </p-inputGroupAddon>
                <input
                    type="text"
                    pInputText
                    [(ngModel)]="searchText"
                    (ngModelChange)="applyFilters()"
                    placeholder="Поиск..."
                />
            </p-inputGroup>

            <!-- Category Filter -->
            <p-select
                [options]="categories"
                [(ngModel)]="selectedCategory"
                (ngModelChange)="applyFilters()"
                optionLabel="label"
                optionValue="value"
                placeholder="Категория"
                [showClear]="true"
                class="filter-select"
            ></p-select>

            <!-- Department Filter -->
            <p-select
                [options]="departments"
                [(ngModel)]="selectedDepartment"
                (ngModelChange)="applyFilters()"
                optionLabel="label"
                optionValue="value"
                placeholder="Отдел"
                [showClear]="true"
                class="filter-select"
            ></p-select>

            <!-- Period Filter -->
            <p-select
                [options]="periods"
                [(ngModel)]="selectedPeriod"
                (ngModelChange)="applyFilters()"
                optionLabel="label"
                optionValue="value"
                placeholder="Период"
                [showClear]="true"
                class="filter-select"
            ></p-select>

            <!-- Status Filter -->
            <p-select
                [options]="statuses"
                [(ngModel)]="selectedStatus"
                (ngModelChange)="applyFilters()"
                optionLabel="label"
                optionValue="value"
                placeholder="Статус"
                [showClear]="true"
                class="filter-select"
            ></p-select>

            <!-- Clear Filters -->
            <p-button
                icon="pi pi-filter-slash"
                severity="secondary"
                [outlined]="true"
                (onClick)="clearFilters()"
                pTooltip="Сбросить фильтры"
            ></p-button>
        </div>

        <!-- Action Buttons -->
        <div class="toolbar-actions">
            <p-button
                label="Excel"
                icon="pi pi-file-excel"
                severity="success"
                [outlined]="true"
                (onClick)="exportToExcel()"
            ></p-button>
            <p-button
                label="Добавить KPI"
                icon="pi pi-plus"
                (onClick)="openNewKpi()"
            ></p-button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-card">
        <p-table
            [value]="filteredKpis"
            [tableStyle]="{'min-width': '85rem'}"
            [paginator]="true"
            [rows]="10"
            [rowsPerPageOptions]="[5, 10, 25, 50]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Показано {first} - {last} из {totalRecords} показателей"
            [sortField]="'weight'"
            [sortOrder]="-1"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="name" style="min-width: 250px">
                        Показатель <p-sortIcon field="name"></p-sortIcon>
                    </th>
                    <th style="width: 120px">Категория</th>
                    <th pSortableColumn="targetValue" style="width: 110px; text-align: right">
                        Цель <p-sortIcon field="targetValue"></p-sortIcon>
                    </th>
                    <th pSortableColumn="actualValue" style="width: 110px; text-align: right">
                        Факт <p-sortIcon field="actualValue"></p-sortIcon>
                    </th>
                    <th style="width: 180px">Выполнение</th>
                    <th style="width: 60px; text-align: center">Тренд</th>
                    <th pSortableColumn="weight" style="width: 70px; text-align: center">
                        Вес <p-sortIcon field="weight"></p-sortIcon>
                    </th>
                    <th style="width: 110px">Статус</th>
                    <th style="width: 130px">Ответственный</th>
                    <th style="width: 100px; text-align: center">Действия</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-kpi>
                <tr>
                    <td>
                        <div class="flex flex-column">
                            <span class="font-semibold">{{ kpi.name }}</span>
                            <span class="text-sm text-500">{{ getDepartmentLabel(kpi.department) }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="flex align-items-center gap-2">
                            <i [class]="getCategoryIcon(kpi.category)" class="text-500"></i>
                            <span>{{ getCategoryLabel(kpi.category) }}</span>
                        </div>
                    </td>
                    <td class="text-right">
                        <span class="text-blue-600 font-semibold">
                            {{ formatValue(kpi.targetValue, kpi.unit) }}
                        </span>
                    </td>
                    <td class="text-right">
                        <span class="font-semibold" [ngClass]="{
                            'text-green-600': getKpiStatus(kpi) === 'achieved',
                            'text-orange-500': getKpiStatus(kpi) === 'warning',
                            'text-red-500': getKpiStatus(kpi) === 'critical'
                        }">
                            {{ formatValue(kpi.actualValue, kpi.unit) }}
                        </span>
                    </td>
                    <td>
                        <div class="kpi-progress">
                            <div class="progress-info">
                                <span class="progress-percent" [ngClass]="{
                                    'text-green-600': getKpiStatus(kpi) === 'achieved',
                                    'text-orange-500': getKpiStatus(kpi) === 'warning',
                                    'text-red-500': getKpiStatus(kpi) === 'critical'
                                }">{{ getAchievementPercent(kpi) | number:'1.1-1' }}%</span>
                            </div>
                            <p-progressBar
                                [value]="getAchievementPercent(kpi) > 100 ? 100 : getAchievementPercent(kpi)"
                                [showValue]="false"
                                [style]="{ height: '8px' }"
                                [style.--p-progressbar-value-background]="getProgressBarColor(kpi)"
                            ></p-progressBar>
                        </div>
                    </td>
                    <td class="text-center">
                        <i [class]="getTrendIcon(kpi.trend)" [ngClass]="getTrendClass(kpi.trend)" class="text-lg"></i>
                    </td>
                    <td class="text-center">
                        <span class="font-semibold text-primary">{{ kpi.weight }}%</span>
                    </td>
                    <td>
                        <p-tag
                            [value]="getStatusLabel(getKpiStatus(kpi))"
                            [severity]="getStatusSeverity(getKpiStatus(kpi))"
                        ></p-tag>
                    </td>
                    <td>
                        <span class="text-sm">{{ kpi.responsiblePerson }}</span>
                    </td>
                    <td class="text-center">
                        <div class="flex align-items-center justify-content-center gap-1">
                            <p-button
                                icon="pi pi-pencil"
                                [rounded]="true"
                                [text]="true"
                                severity="info"
                                (onClick)="editKpi(kpi)"
                                pTooltip="Редактировать"
                            ></p-button>
                            <p-button
                                icon="pi pi-trash"
                                [rounded]="true"
                                [text]="true"
                                severity="danger"
                                (onClick)="deleteKpi(kpi)"
                                pTooltip="Удалить"
                            ></p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="10" class="text-center p-4">
                        <div class="flex flex-column align-items-center gap-2">
                            <i class="pi pi-inbox text-4xl text-500"></i>
                            <span class="text-500">Показатели не найдены</span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- KPI Dialog -->
<p-dialog
    [(visible)]="kpiDialog"
    [header]="isEditMode ? 'Редактирование KPI' : 'Новый показатель KPI'"
    [modal]="true"
    [style]="{ width: '650px', maxWidth: '95vw' }"
    [closable]="true"
    [draggable]="false"
    styleClass="kpi-dialog"
>
    <div class="dialog-form">
        <!-- Name -->
        <div class="form-field">
            <label for="name">Название показателя <span class="required">*</span></label>
            <input
                id="name"
                type="text"
                pInputText
                [(ngModel)]="currentKpi.name"
                placeholder="Введите название KPI"
            />
        </div>

        <!-- Category & Department Row -->
        <div class="form-row">
            <div class="form-field">
                <label for="category">Категория</label>
                <p-select
                    id="category"
                    [options]="categories"
                    [(ngModel)]="currentKpi.category"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
            <div class="form-field">
                <label for="department">Ответственный отдел</label>
                <p-select
                    id="department"
                    [options]="departments"
                    [(ngModel)]="currentKpi.department"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
        </div>

        <!-- Period & Date Row -->
        <div class="form-row">
            <div class="form-field">
                <label for="period">Период</label>
                <p-select
                    id="period"
                    [options]="periods"
                    [(ngModel)]="currentKpi.period"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
            <div class="form-field">
                <label for="periodDate">Дата периода</label>
                <p-datepicker
                    id="periodDate"
                    [(ngModel)]="currentKpi.periodDate"
                    [showIcon]="true"
                    dateFormat="dd.mm.yy"
                    appendTo="body"
                ></p-datepicker>
            </div>
        </div>

        <!-- Unit & Weight Row -->
        <div class="form-row">
            <div class="form-field">
                <label for="unit">Единица измерения</label>
                <p-select
                    id="unit"
                    [options]="units"
                    [(ngModel)]="currentKpi.unit"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
            <div class="form-field">
                <label for="weight">Вес показателя (%)</label>
                <p-inputNumber
                    id="weight"
                    [(ngModel)]="currentKpi.weight"
                    [min]="1"
                    [max]="100"
                    suffix="%"
                ></p-inputNumber>
            </div>
        </div>

        <!-- Target, Actual, Min Threshold Row -->
        <div class="form-row-3">
            <div class="form-field">
                <label for="targetValue" class="label-target">
                    <i class="pi pi-flag"></i> Цель
                </label>
                <p-inputNumber
                    id="targetValue"
                    [(ngModel)]="currentKpi.targetValue"
                    mode="decimal"
                    [minFractionDigits]="0"
                    [maxFractionDigits]="2"
                ></p-inputNumber>
            </div>
            <div class="form-field">
                <label for="actualValue" class="label-actual">
                    <i class="pi pi-check"></i> Факт
                </label>
                <p-inputNumber
                    id="actualValue"
                    [(ngModel)]="currentKpi.actualValue"
                    mode="decimal"
                    [minFractionDigits]="0"
                    [maxFractionDigits]="2"
                ></p-inputNumber>
            </div>
            <div class="form-field">
                <label for="minThreshold" class="label-threshold">
                    <i class="pi pi-exclamation-triangle"></i> Мин. порог
                </label>
                <p-inputNumber
                    id="minThreshold"
                    [(ngModel)]="currentKpi.minThreshold"
                    mode="decimal"
                    [minFractionDigits]="0"
                    [maxFractionDigits]="2"
                ></p-inputNumber>
            </div>
        </div>

        <!-- Trend & Responsible Row -->
        <div class="form-row">
            <div class="form-field">
                <label for="trend">Тренд</label>
                <p-select
                    id="trend"
                    [options]="trends"
                    [(ngModel)]="currentKpi.trend"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
            <div class="form-field">
                <label for="responsiblePerson">Ответственный</label>
                <input
                    id="responsiblePerson"
                    type="text"
                    pInputText
                    [(ngModel)]="currentKpi.responsiblePerson"
                    placeholder="ФИО ответственного"
                />
            </div>
        </div>

        <!-- Notes -->
        <div class="form-field">
            <label for="notes">Примечания</label>
            <textarea
                id="notes"
                pInputTextarea
                [(ngModel)]="currentKpi.notes"
                rows="2"
                placeholder="Дополнительная информация"
            ></textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="dialog-footer">
            <p-button
                label="Отмена"
                severity="secondary"
                [outlined]="true"
                icon="pi pi-times"
                (onClick)="kpiDialog = false"
            ></p-button>
            <p-button
                [label]="isEditMode ? 'Сохранить' : 'Добавить'"
                [icon]="isEditMode ? 'pi pi-save' : 'pi pi-plus'"
                (onClick)="saveKpi()"
            ></p-button>
        </div>
    </ng-template>
</p-dialog>
