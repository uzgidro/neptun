<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="procurement-container">
    <!-- Summary Cards Row -->
    <div class="summary-cards-row">
        <div class="summary-card total-card">
            <div class="card-content">
                <div class="card-icon total-icon">
                    <i class="pi pi-shopping-cart"></i>
                </div>
                <div class="card-info">
                    <span class="card-label">Всего закупок</span>
                    <span class="card-value text-primary">{{ totalProcurementsCount }}</span>
                </div>
            </div>
        </div>

        <div class="summary-card amount-card">
            <div class="card-content">
                <div class="card-icon amount-icon">
                    <i class="pi pi-wallet"></i>
                </div>
                <div class="card-info">
                    <span class="card-label">Общая сумма</span>
                    <span class="card-value text-blue-500">{{ formatCurrency(totalAmount) }}</span>
                </div>
            </div>
        </div>

        <div class="summary-card pending-card">
            <div class="card-content">
                <div class="card-icon pending-icon">
                    <i class="pi pi-clock"></i>
                </div>
                <div class="card-info">
                    <span class="card-label">В ожидании</span>
                    <span class="card-value text-orange-500">{{ pendingCount }}</span>
                </div>
            </div>
        </div>

        <div class="summary-card progress-card">
            <div class="card-content">
                <div class="card-icon progress-icon">
                    <i class="pi pi-spin pi-spinner"></i>
                </div>
                <div class="card-info">
                    <span class="card-label">В процессе</span>
                    <span class="card-value text-cyan-500">{{ inProgressCount }}</span>
                </div>
            </div>
        </div>

        <div class="summary-card delivered-card">
            <div class="card-content">
                <div class="card-icon delivered-icon">
                    <i class="pi pi-check-circle"></i>
                </div>
                <div class="card-info">
                    <span class="card-label">Доставлено</span>
                    <span class="card-value text-green-500">{{ deliveredCount }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Monthly Dynamics Chart -->
        <div class="chart-card chart-large">
            <div class="chart-header">
                <h3>Динамика закупок по месяцам</h3>
                <span class="chart-icon"><i class="pi pi-chart-bar"></i></span>
            </div>
            <div class="chart-body">
                <p-chart
                    type="bar"
                    [data]="monthlyChartData"
                    [options]="monthlyChartOptions"
                ></p-chart>
            </div>
        </div>

        <!-- Right side charts -->
        <div class="charts-right">
            <!-- Status Chart -->
            <div class="chart-card chart-small">
                <div class="chart-header">
                    <h3>По статусам</h3>
                    <span class="chart-icon"><i class="pi pi-chart-pie"></i></span>
                </div>
                <div class="chart-body-small">
                    <p-chart
                        type="doughnut"
                        [data]="statusChartData"
                        [options]="statusChartOptions"
                    ></p-chart>
                </div>
            </div>

            <!-- Category Chart -->
            <div class="chart-card chart-small">
                <div class="chart-header">
                    <h3>По категориям</h3>
                    <span class="chart-icon"><i class="pi pi-percentage"></i></span>
                </div>
                <div class="chart-body-small">
                    <p-chart
                        type="pie"
                        [data]="categoryChartData"
                        [options]="categoryChartOptions"
                    ></p-chart>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Suppliers Chart -->
    <div class="supplier-chart-section">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Топ-5 поставщиков по объёму</h3>
                <span class="chart-icon"><i class="pi pi-users"></i></span>
            </div>
            <div class="chart-body-supplier">
                <p-chart
                    type="bar"
                    [data]="supplierChartData"
                    [options]="supplierChartOptions"
                ></p-chart>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar-card">
        <div class="toolbar-filters">
            <!-- Search -->
            <p-inputGroup class="search-input">
                <p-inputGroupAddon>
                    <i class="pi pi-search"></i>
                </p-inputGroupAddon>
                <input
                    type="text"
                    pInputText
                    [(ngModel)]="searchText"
                    (ngModelChange)="applyFilters()"
                    placeholder="Поиск..."
                />
            </p-inputGroup>

            <!-- Date Range -->
            <p-datepicker
                [(ngModel)]="dateRange"
                (ngModelChange)="applyFilters()"
                selectionMode="range"
                [showIcon]="true"
                dateFormat="dd.mm.yy"
                placeholder="Период"
                class="date-picker"
            ></p-datepicker>

            <!-- Category Filter -->
            <p-select
                [options]="categories"
                [(ngModel)]="selectedCategory"
                (ngModelChange)="applyFilters()"
                optionLabel="label"
                optionValue="value"
                placeholder="Категория"
                [showClear]="true"
                class="filter-select"
            ></p-select>

            <!-- Status Filter -->
            <p-select
                [options]="statuses"
                [(ngModel)]="selectedStatus"
                (ngModelChange)="applyFilters()"
                optionLabel="label"
                optionValue="value"
                placeholder="Статус"
                [showClear]="true"
                class="filter-select"
            ></p-select>

            <!-- Priority Filter -->
            <p-select
                [options]="priorities"
                [(ngModel)]="selectedPriority"
                (ngModelChange)="applyFilters()"
                optionLabel="label"
                optionValue="value"
                placeholder="Приоритет"
                [showClear]="true"
                class="filter-select"
            ></p-select>

            <!-- Department Filter -->
            <p-select
                [options]="departments"
                [(ngModel)]="selectedDepartment"
                (ngModelChange)="applyFilters()"
                optionLabel="label"
                optionValue="value"
                placeholder="Отдел"
                [showClear]="true"
                class="filter-select"
            ></p-select>

            <!-- Clear Filters -->
            <p-button
                icon="pi pi-filter-slash"
                severity="secondary"
                [outlined]="true"
                (onClick)="clearFilters()"
                pTooltip="Сбросить фильтры"
            ></p-button>
        </div>

        <!-- Action Buttons -->
        <div class="toolbar-actions">
            <p-button
                label="Excel"
                icon="pi pi-file-excel"
                severity="success"
                [outlined]="true"
                (onClick)="exportToExcel()"
            ></p-button>
            <p-button
                label="Новая заявка"
                icon="pi pi-plus"
                (onClick)="openNewProcurement()"
            ></p-button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-card">
        <p-table
            [value]="filteredProcurements"
            [tableStyle]="{'min-width': '90rem'}"
            [paginator]="true"
            [rows]="10"
            [rowsPerPageOptions]="[5, 10, 25, 50]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Показано {first} - {last} из {totalRecords} записей"
            [sortField]="'requestDate'"
            [sortOrder]="-1"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="requestNumber" style="width: 130px">
                        № заявки <p-sortIcon field="requestNumber"></p-sortIcon>
                    </th>
                    <th pSortableColumn="requestDate" style="width: 100px">
                        Дата <p-sortIcon field="requestDate"></p-sortIcon>
                    </th>
                    <th pSortableColumn="itemName">
                        Наименование <p-sortIcon field="itemName"></p-sortIcon>
                    </th>
                    <th style="width: 110px">Категория</th>
                    <th pSortableColumn="supplier" style="width: 130px">
                        Поставщик <p-sortIcon field="supplier"></p-sortIcon>
                    </th>
                    <th style="width: 90px; text-align: center">Кол-во</th>
                    <th pSortableColumn="totalAmount" style="width: 140px; text-align: right">
                        Сумма <p-sortIcon field="totalAmount"></p-sortIcon>
                    </th>
                    <th style="width: 100px">Приоритет</th>
                    <th style="width: 110px">Статус</th>
                    <th style="width: 100px">План. дата</th>
                    <th style="width: 100px; text-align: center">Действия</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-procurement>
                <tr [ngClass]="{'overdue-row': isOverdue(procurement)}">
                    <td>
                        <span class="font-semibold text-primary">{{ procurement.requestNumber }}</span>
                    </td>
                    <td>{{ procurement.requestDate | date: 'dd.MM.yyyy' }}</td>
                    <td>
                        <div class="flex flex-column">
                            <span class="font-semibold">{{ procurement.itemName }}</span>
                            <span class="text-sm text-500">{{ getDepartmentLabel(procurement.department) }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="flex align-items-center gap-2">
                            <i [class]="getCategoryIcon(procurement.category)" class="text-500"></i>
                            <span>{{ getCategoryLabel(procurement.category) }}</span>
                        </div>
                    </td>
                    <td>{{ procurement.supplier }}</td>
                    <td class="text-center">
                        <span class="font-semibold">{{ procurement.quantity }}</span>
                        <span class="text-500 text-sm ml-1">{{ getUnitLabel(procurement.unit) }}</span>
                    </td>
                    <td class="text-right">
                        <span class="text-blue-600 font-semibold">
                            {{ formatCurrency(procurement.totalAmount) }}
                        </span>
                    </td>
                    <td>
                        <p-tag
                            [value]="getPriorityLabel(procurement.priority)"
                            [severity]="getPrioritySeverity(procurement.priority)"
                        ></p-tag>
                    </td>
                    <td>
                        <p-tag
                            [value]="getStatusLabel(procurement.status)"
                            [severity]="getStatusSeverity(procurement.status)"
                        ></p-tag>
                    </td>
                    <td>
                        <span *ngIf="procurement.plannedDeliveryDate" [ngClass]="{'text-red-500': isOverdue(procurement)}">
                            {{ procurement.plannedDeliveryDate | date: 'dd.MM.yyyy' }}
                        </span>
                        <span *ngIf="!procurement.plannedDeliveryDate" class="text-400">-</span>
                    </td>
                    <td class="text-center">
                        <div class="flex align-items-center justify-content-center gap-1">
                            <p-button
                                icon="pi pi-pencil"
                                [rounded]="true"
                                [text]="true"
                                severity="info"
                                (onClick)="editProcurement(procurement)"
                                pTooltip="Редактировать"
                            ></p-button>
                            <p-button
                                icon="pi pi-trash"
                                [rounded]="true"
                                [text]="true"
                                severity="danger"
                                (onClick)="deleteProcurement(procurement)"
                                pTooltip="Удалить"
                            ></p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="footer">
                <tr class="font-bold">
                    <td colspan="6" class="text-right">ИТОГО:</td>
                    <td class="text-right text-blue-600">{{ formatCurrency(totalAmount) }}</td>
                    <td colspan="4"></td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="11" class="text-center p-4">
                        <div class="flex flex-column align-items-center gap-2">
                            <i class="pi pi-inbox text-4xl text-500"></i>
                            <span class="text-500">Заявки не найдены</span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Procurement Dialog -->
<p-dialog
    [(visible)]="procurementDialog"
    [header]="isEditMode ? 'Редактирование заявки' : 'Новая заявка на закупку'"
    [modal]="true"
    [style]="{ width: '700px', maxWidth: '95vw' }"
    [closable]="true"
    [draggable]="false"
    styleClass="procurement-dialog"
>
    <div class="dialog-form">
        <!-- Request Number & Date Row -->
        <div class="form-row">
            <div class="form-field">
                <label for="requestNumber">Номер заявки</label>
                <input
                    id="requestNumber"
                    type="text"
                    pInputText
                    [(ngModel)]="currentProcurement.requestNumber"
                    [disabled]="true"
                />
            </div>
            <div class="form-field">
                <label for="requestDate">Дата заявки <span class="required">*</span></label>
                <p-datepicker
                    id="requestDate"
                    [(ngModel)]="currentProcurement.requestDate"
                    [showIcon]="true"
                    dateFormat="dd.mm.yy"
                    appendTo="body"
                ></p-datepicker>
            </div>
        </div>

        <!-- Item Name -->
        <div class="form-field">
            <label for="itemName">Наименование товара/услуги <span class="required">*</span></label>
            <input
                id="itemName"
                type="text"
                pInputText
                [(ngModel)]="currentProcurement.itemName"
                placeholder="Введите наименование"
            />
        </div>

        <!-- Category & Department Row -->
        <div class="form-row">
            <div class="form-field">
                <label for="category">Категория</label>
                <p-select
                    id="category"
                    [options]="categories"
                    [(ngModel)]="currentProcurement.category"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
            <div class="form-field">
                <label for="department">Отдел-заказчик</label>
                <p-select
                    id="department"
                    [options]="departments"
                    [(ngModel)]="currentProcurement.department"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
        </div>

        <!-- Supplier -->
        <div class="form-field">
            <label for="supplier">Поставщик <span class="required">*</span></label>
            <input
                id="supplier"
                type="text"
                pInputText
                [(ngModel)]="currentProcurement.supplier"
                placeholder="Введите название поставщика"
            />
        </div>

        <!-- Quantity, Unit, Unit Price Row -->
        <div class="form-row-3">
            <div class="form-field">
                <label for="quantity">Количество <span class="required">*</span></label>
                <p-inputNumber
                    id="quantity"
                    [(ngModel)]="currentProcurement.quantity"
                    [min]="1"
                    (ngModelChange)="calculateTotal()"
                ></p-inputNumber>
            </div>
            <div class="form-field">
                <label for="unit">Ед. изм.</label>
                <p-select
                    id="unit"
                    [options]="units"
                    [(ngModel)]="currentProcurement.unit"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
            <div class="form-field">
                <label for="unitPrice">Цена за ед. <span class="required">*</span></label>
                <p-inputNumber
                    id="unitPrice"
                    [(ngModel)]="currentProcurement.unitPrice"
                    mode="decimal"
                    [minFractionDigits]="0"
                    [maxFractionDigits]="0"
                    suffix=" UZS"
                    (ngModelChange)="calculateTotal()"
                ></p-inputNumber>
            </div>
        </div>

        <!-- Total Amount (readonly) -->
        <div class="form-field">
            <label class="label-total">
                <i class="pi pi-calculator"></i> Общая сумма
            </label>
            <div class="total-display">
                {{ formatCurrency(currentProcurement.totalAmount) }}
            </div>
        </div>

        <!-- Priority & Status Row -->
        <div class="form-row">
            <div class="form-field">
                <label for="priority">Приоритет</label>
                <p-select
                    id="priority"
                    [options]="priorities"
                    [(ngModel)]="currentProcurement.priority"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
            <div class="form-field">
                <label for="status">Статус</label>
                <p-select
                    id="status"
                    [options]="statuses"
                    [(ngModel)]="currentProcurement.status"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                ></p-select>
            </div>
        </div>

        <!-- Delivery Dates Row -->
        <div class="form-row">
            <div class="form-field">
                <label for="plannedDeliveryDate">
                    <i class="pi pi-calendar"></i> Плановая дата поставки
                </label>
                <p-datepicker
                    id="plannedDeliveryDate"
                    [(ngModel)]="currentProcurement.plannedDeliveryDate"
                    [showIcon]="true"
                    dateFormat="dd.mm.yy"
                    appendTo="body"
                    placeholder="Выберите дату"
                ></p-datepicker>
            </div>
            <div class="form-field">
                <label for="actualDeliveryDate">
                    <i class="pi pi-check-circle"></i> Фактическая дата поставки
                </label>
                <p-datepicker
                    id="actualDeliveryDate"
                    [(ngModel)]="currentProcurement.actualDeliveryDate"
                    [showIcon]="true"
                    dateFormat="dd.mm.yy"
                    appendTo="body"
                    placeholder="Выберите дату"
                ></p-datepicker>
            </div>
        </div>

        <!-- Responsible Person -->
        <div class="form-field">
            <label for="responsiblePerson">Ответственный</label>
            <input
                id="responsiblePerson"
                type="text"
                pInputText
                [(ngModel)]="currentProcurement.responsiblePerson"
                placeholder="ФИО ответственного"
            />
        </div>

        <!-- Notes -->
        <div class="form-field">
            <label for="notes">Примечания</label>
            <textarea
                id="notes"
                pInputTextarea
                [(ngModel)]="currentProcurement.notes"
                rows="3"
                placeholder="Дополнительная информация"
            ></textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="dialog-footer">
            <p-button
                label="Отмена"
                severity="secondary"
                [outlined]="true"
                icon="pi pi-times"
                (onClick)="procurementDialog = false"
            ></p-button>
            <p-button
                [label]="isEditMode ? 'Сохранить' : 'Создать заявку'"
                [icon]="isEditMode ? 'pi pi-save' : 'pi pi-plus'"
                (onClick)="saveProcurement()"
            ></p-button>
        </div>
    </ng-template>
</p-dialog>
