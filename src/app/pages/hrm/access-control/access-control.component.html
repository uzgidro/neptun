<div class="access-control-container">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">Контроль доступа</h1>
            <p class="text-surface-600 dark:text-surface-400 mt-1">Управление пропусками и мониторинг</p>
        </div>
        <div class="flex gap-2">
            <button pButton label="Выдать карту" icon="pi pi-id-card" (click)="openNewCardDialog()"></button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
        <div class="bg-surface-0 dark:bg-surface-800 rounded-lg p-4 border border-surface-200 dark:border-surface-700">
            <div class="text-center">
                <i class="pi pi-id-card text-2xl text-blue-500 mb-2"></i>
                <p class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">{{ stats.active_cards }}</p>
                <p class="text-xs text-surface-500 dark:text-surface-400 m-0">Активных карт</p>
            </div>
        </div>

        <div class="bg-surface-0 dark:bg-surface-800 rounded-lg p-4 border border-surface-200 dark:border-surface-700">
            <div class="text-center">
                <i class="pi pi-users text-2xl text-green-500 mb-2"></i>
                <p class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">{{ stats.current_on_site }}</p>
                <p class="text-xs text-surface-500 dark:text-surface-400 m-0">На территории</p>
            </div>
        </div>

        <div class="bg-surface-0 dark:bg-surface-800 rounded-lg p-4 border border-surface-200 dark:border-surface-700">
            <div class="text-center">
                <i class="pi pi-sign-in text-2xl text-cyan-500 mb-2"></i>
                <p class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">{{ stats.entries_today }}</p>
                <p class="text-xs text-surface-500 dark:text-surface-400 m-0">Входов сегодня</p>
            </div>
        </div>

        <div class="bg-surface-0 dark:bg-surface-800 rounded-lg p-4 border border-surface-200 dark:border-surface-700">
            <div class="text-center">
                <i class="pi pi-sign-out text-2xl text-orange-500 mb-2"></i>
                <p class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">{{ stats.exits_today }}</p>
                <p class="text-xs text-surface-500 dark:text-surface-400 m-0">Выходов сегодня</p>
            </div>
        </div>

        <div class="bg-surface-0 dark:bg-surface-800 rounded-lg p-4 border border-surface-200 dark:border-surface-700">
            <div class="text-center">
                <i class="pi pi-ban text-2xl text-red-500 mb-2"></i>
                <p class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">{{ stats.denied_today }}</p>
                <p class="text-xs text-surface-500 dark:text-surface-400 m-0">Отказов</p>
            </div>
        </div>

        <div class="bg-surface-0 dark:bg-surface-800 rounded-lg p-4 border border-surface-200 dark:border-surface-700">
            <div class="text-center">
                <i class="pi pi-inbox text-2xl text-purple-500 mb-2"></i>
                <p class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">{{ stats.pending_requests }}</p>
                <p class="text-xs text-surface-500 dark:text-surface-400 m-0">Заявок</p>
            </div>
        </div>
    </div>

    <!-- Zone Occupancy -->
    <div class="bg-surface-0 dark:bg-surface-800 rounded-lg p-4 mb-6 border border-surface-200 dark:border-surface-700">
        <h3 class="text-lg font-semibold text-surface-900 dark:text-surface-0 mb-4">Заполненность зон</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            @for (zone of zoneOccupancy; track zone.zone_id) {
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-surface-700 dark:text-surface-300">{{ zone.zone_name }}</span>
                        <span class="text-sm text-surface-500">{{ zone.current }} / {{ zone.max }}</span>
                    </div>
                    <p-progressbar [value]="zone.percentage" [showValue]="false" [style]="{ height: '8px' }"
                        [styleClass]="'occupancy-bar occupancy-' + getOccupancyColor(zone.percentage)"></p-progressbar>
                </div>
            }
        </div>
    </div>

    <!-- Tabs -->
    <p-tabs [value]="activeTabIndex" (valueChange)="onTabChange($event)">
        <p-tablist>
            <p-tab [value]="0">
                <i class="pi pi-id-card mr-2"></i>
                Карты доступа
            </p-tab>
            <p-tab [value]="1">
                <i class="pi pi-list mr-2"></i>
                Журнал событий
            </p-tab>
            <p-tab [value]="2">
                <i class="pi pi-inbox mr-2"></i>
                Заявки
                @if (stats.pending_requests > 0) {
                    <span class="ml-2 bg-red-500 text-white text-xs rounded-full px-2 py-0.5">{{ stats.pending_requests }}</span>
                }
            </p-tab>
            <p-tab [value]="3">
                <i class="pi pi-map-marker mr-2"></i>
                Зоны доступа
            </p-tab>
        </p-tablist>

        <p-tabpanels>
            <!-- Cards Tab -->
            <p-tabpanel [value]="0">
                <div class="flex flex-wrap gap-4 items-end mb-4">
                    <div class="flex-1 min-w-64">
                        <p-inputgroup>
                            <p-inputgroup-addon><i class="pi pi-search"></i></p-inputgroup-addon>
                            <input pInputText [(ngModel)]="searchQuery" placeholder="Поиск по ФИО, номеру карты..." class="w-full" />
                        </p-inputgroup>
                    </div>
                    <p-select [options]="cardStatuses" [(ngModel)]="selectedCardStatus" optionLabel="label" optionValue="value"
                        placeholder="Статус" [showClear]="true" class="w-40"></p-select>
                    <p-select [options]="zones" [(ngModel)]="selectedZone" optionLabel="name" optionValue="id"
                        placeholder="Зона" [showClear]="true" class="w-48"></p-select>
                    <button pButton icon="pi pi-filter-slash" class="p-button-outlined" pTooltip="Сбросить" (click)="clearFilters()"></button>
                </div>

                <p-table [value]="filteredCards" [loading]="loading" [paginator]="true" [rows]="10" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Номер карты</th>
                            <th>Сотрудник</th>
                            <th>Отдел</th>
                            <th>Статус</th>
                            <th>Зоны доступа</th>
                            <th>Действует до</th>
                            <th>Последний вход</th>
                            <th style="width: 120px">Действия</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-card>
                        <tr>
                            <td><span class="font-mono text-sm">{{ card.card_number }}</span></td>
                            <td>
                                <div>
                                    <div class="font-medium">{{ card.employee_name }}</div>
                                    <div class="text-xs text-surface-500">{{ card.position_name }}</div>
                                </div>
                            </td>
                            <td>{{ card.department_name }}</td>
                            <td><p-tag [value]="getCardStatusLabel(card.status)" [severity]="getCardStatusSeverity(card.status)"></p-tag></td>
                            <td>
                                <span class="text-sm" pTooltip="{{ getZoneNames(card.access_zones) }}">
                                    {{ card.access_zones.length }} зон(ы)
                                </span>
                            </td>
                            <td>{{ formatDate(card.valid_until) }}</td>
                            <td>
                                @if (card.last_used_at) {
                                    <div class="text-sm">{{ formatTime(card.last_used_at) }}</div>
                                    <div class="text-xs text-surface-500">{{ card.last_zone }}</div>
                                } @else {
                                    <span class="text-surface-400">—</span>
                                }
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button pButton icon="pi pi-pencil" class="p-button-text p-button-sm" pTooltip="Редактировать" (click)="openEditCardDialog(card)"></button>
                                    @if (card.status === 'active') {
                                        <button pButton icon="pi pi-lock" class="p-button-text p-button-sm p-button-danger" pTooltip="Заблокировать" (click)="openBlockDialog(card)"></button>
                                    }
                                    @if (card.status === 'blocked') {
                                        <button pButton icon="pi pi-lock-open" class="p-button-text p-button-sm p-button-success" pTooltip="Разблокировать" (click)="unblockCard(card)"></button>
                                    }
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="8" class="text-center p-8">
                                <i class="pi pi-id-card text-4xl text-surface-300 mb-2"></i>
                                <p class="text-surface-500 m-0">Карты не найдены</p>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>

            <!-- Logs Tab -->
            <p-tabpanel [value]="1">
                <div class="flex flex-wrap gap-4 items-end mb-4">
                    <p-select [options]="accessEventStatuses" [(ngModel)]="selectedLogStatus" optionLabel="label" optionValue="value"
                        placeholder="Статус" [showClear]="true" class="w-40"></p-select>
                    <p-select [options]="zones" [(ngModel)]="selectedZone" optionLabel="name" optionValue="id"
                        placeholder="Зона" [showClear]="true" class="w-48"></p-select>
                    <button pButton icon="pi pi-refresh" class="p-button-outlined" pTooltip="Обновить" (click)="loadLogs()"></button>
                </div>

                <p-table [value]="filteredLogs" [paginator]="true" [rows]="15" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 160px">Время</th>
                            <th>Сотрудник</th>
                            <th>Карта</th>
                            <th>Зона</th>
                            <th>Считыватель</th>
                            <th style="width: 100px">Направление</th>
                            <th style="width: 120px">Статус</th>
                            <th>Причина отказа</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-log>
                        <tr [ngClass]="{'denied-row': log.status === 'denied'}">
                            <td>{{ formatDateTime(log.timestamp) }}</td>
                            <td>{{ log.employee_name }}</td>
                            <td><span class="font-mono text-xs">{{ log.card_number }}</span></td>
                            <td>{{ log.zone_name }}</td>
                            <td>{{ log.reader_name }}</td>
                            <td>
                                <span class="inline-flex items-center gap-1">
                                    <i class="pi" [ngClass]="log.direction === 'entry' ? 'pi-sign-in text-green-500' : 'pi-sign-out text-orange-500'"></i>
                                    {{ log.direction === 'entry' ? 'Вход' : 'Выход' }}
                                </span>
                            </td>
                            <td><p-tag [value]="getAccessStatusLabel(log.status)" [severity]="getAccessStatusSeverity(log.status)"></p-tag></td>
                            <td>
                                @if (log.denial_reason) {
                                    <span class="text-red-600 dark:text-red-400 text-sm">{{ log.denial_reason }}</span>
                                } @else {
                                    <span class="text-surface-400">—</span>
                                }
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>

            <!-- Requests Tab -->
            <p-tabpanel [value]="2">
                <p-table [value]="requests" [paginator]="true" [rows]="10" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Сотрудник</th>
                            <th>Отдел</th>
                            <th>Запрашиваемые зоны</th>
                            <th>Причина</th>
                            <th>Период</th>
                            <th>Статус</th>
                            <th>Дата заявки</th>
                            <th style="width: 120px">Действия</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-request>
                        <tr>
                            <td>{{ request.employee_name }}</td>
                            <td>{{ request.department_name }}</td>
                            <td>
                                <div class="flex flex-wrap gap-1">
                                    @for (zone of request.requested_zone_names; track zone) {
                                        <span class="bg-surface-100 dark:bg-surface-700 px-2 py-0.5 rounded text-xs">{{ zone }}</span>
                                    }
                                </div>
                            </td>
                            <td>{{ request.reason }}</td>
                            <td>
                                <div class="text-sm">
                                    {{ formatDate(request.valid_from) }}
                                    @if (request.valid_until) {
                                        — {{ formatDate(request.valid_until) }}
                                    } @else {
                                        — бессрочно
                                    }
                                </div>
                                @if (request.is_temporary) {
                                    <span class="text-xs text-orange-500">Временный</span>
                                }
                            </td>
                            <td><p-tag [value]="getRequestStatusLabel(request.status)" [severity]="getRequestStatusSeverity(request.status)"></p-tag></td>
                            <td>{{ formatDate(request.requested_at) }}</td>
                            <td>
                                @if (request.status === 'pending') {
                                    <div class="flex gap-1">
                                        <button pButton icon="pi pi-check" class="p-button-text p-button-sm p-button-success" pTooltip="Одобрить" (click)="openRequestDialog(request)"></button>
                                        <button pButton icon="pi pi-times" class="p-button-text p-button-sm p-button-danger" pTooltip="Отклонить" (click)="openRequestDialog(request)"></button>
                                    </div>
                                }
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="8" class="text-center p-8">
                                <i class="pi pi-inbox text-4xl text-surface-300 mb-2"></i>
                                <p class="text-surface-500 m-0">Заявок нет</p>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>

            <!-- Zones Tab -->
            <p-tabpanel [value]="3">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    @for (zone of zones; track zone.id) {
                        <div class="bg-surface-0 dark:bg-surface-800 rounded-lg border border-surface-200 dark:border-surface-700 overflow-hidden">
                            <div class="p-4 border-b border-surface-200 dark:border-surface-700 flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-surface-900 dark:text-surface-0 m-0">{{ zone.name }}</h4>
                                    <p class="text-sm text-surface-500 m-0">{{ zone.code }}</p>
                                </div>
                                <span class="security-badge security-{{ getSecurityLevelColor(zone.security_level) }}">
                                    {{ getSecurityLevelLabel(zone.security_level) }}
                                </span>
                            </div>
                            <div class="p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="pi pi-map-marker text-surface-400"></i>
                                    <span class="text-sm text-surface-600 dark:text-surface-400">{{ zone.location }}</span>
                                </div>
                                <div class="flex items-center gap-2 mb-3">
                                    <i class="pi pi-users text-surface-400"></i>
                                    <span class="text-sm text-surface-600 dark:text-surface-400">
                                        {{ zone.current_occupancy }} / {{ zone.max_occupancy }} чел.
                                    </span>
                                </div>
                                @if (zone.requires_escort) {
                                    <div class="flex items-center gap-2 text-orange-500">
                                        <i class="pi pi-exclamation-triangle"></i>
                                        <span class="text-sm">Требуется сопровождение</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>
</div>

<!-- Card Dialog -->
<p-dialog [header]="isEditMode ? 'Редактирование карты' : 'Выдача карты'" [(visible)]="displayCardDialog"
    [modal]="true" [style]="{ width: '550px' }" [draggable]="false" [resizable]="false">
    <div class="flex flex-col gap-4">
        <div class="flex flex-col gap-2">
            <label class="font-medium text-surface-700 dark:text-surface-300">Сотрудник *</label>
            <p-select [options]="employees" [(ngModel)]="cardForm.employee_id" optionLabel="name" optionValue="id"
                placeholder="Выберите сотрудника" [filter]="true" filterPlaceholder="Поиск..." class="w-full"
                [disabled]="isEditMode"></p-select>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col gap-2">
                <label class="font-medium text-surface-700 dark:text-surface-300">Действует с</label>
                <input pInputText type="date" [(ngModel)]="cardForm.valid_from" class="w-full" />
            </div>
            <div class="flex flex-col gap-2">
                <label class="font-medium text-surface-700 dark:text-surface-300">Действует до</label>
                <input pInputText type="date" [(ngModel)]="cardForm.valid_until" class="w-full" />
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <label class="font-medium text-surface-700 dark:text-surface-300">Зоны доступа</label>
            <div class="grid grid-cols-2 gap-2">
                @for (zone of zones; track zone.id) {
                    <div class="flex items-center gap-2 p-2 rounded border cursor-pointer zone-selector"
                        [ngClass]="{'zone-selected': isZoneSelected(zone.id)}"
                        (click)="toggleZoneSelection(zone.id)">
                        <p-checkbox [ngModel]="isZoneSelected(zone.id)" [binary]="true" (click)="$event.stopPropagation()"></p-checkbox>
                        <div>
                            <div class="text-sm font-medium">{{ zone.name }}</div>
                            <div class="text-xs text-surface-500">{{ getSecurityLevelLabel(zone.security_level) }}</div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <label class="font-medium text-surface-700 dark:text-surface-300">Примечание</label>
            <textarea pTextarea [(ngModel)]="cardForm.notes" rows="2" class="w-full"></textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Отмена" class="p-button-text" (click)="displayCardDialog = false"></button>
        <button pButton label="Сохранить" icon="pi pi-check" (click)="saveCard()"></button>
    </ng-template>
</p-dialog>

<!-- Block Dialog -->
<p-dialog header="Блокировка карты" [(visible)]="displayBlockDialog" [modal]="true" [style]="{ width: '400px' }">
    <div class="flex flex-col gap-4" *ngIf="selectedCard">
        <div class="bg-surface-100 dark:bg-surface-700 rounded-lg p-3">
            <p class="font-medium text-surface-900 dark:text-surface-0 m-0">{{ selectedCard.employee_name }}</p>
            <p class="text-sm text-surface-500 m-0">{{ selectedCard.card_number }}</p>
        </div>

        <div class="flex flex-col gap-2">
            <label class="font-medium text-surface-700 dark:text-surface-300">Причина блокировки</label>
            <textarea pTextarea [(ngModel)]="blockReason" rows="3" placeholder="Укажите причину..." class="w-full"></textarea>
        </div>

        <div class="bg-red-50 dark:bg-red-900/30 rounded-lg p-3">
            <div class="flex items-start gap-2">
                <i class="pi pi-exclamation-triangle text-red-500 mt-0.5"></i>
                <p class="text-sm text-red-700 dark:text-red-300 m-0">
                    После блокировки сотрудник не сможет пройти ни в одну зону.
                </p>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Отмена" class="p-button-text" (click)="displayBlockDialog = false"></button>
        <button pButton label="Заблокировать" icon="pi pi-lock" class="p-button-danger" (click)="blockCard()"></button>
    </ng-template>
</p-dialog>

<!-- Request Dialog -->
<p-dialog header="Обработка заявки" [(visible)]="displayRequestDialog" [modal]="true" [style]="{ width: '500px' }">
    <div class="flex flex-col gap-4" *ngIf="selectedRequest">
        <div class="bg-surface-100 dark:bg-surface-700 rounded-lg p-4">
            <p class="font-medium text-surface-900 dark:text-surface-0 m-0">{{ selectedRequest.employee_name }}</p>
            <p class="text-sm text-surface-500 m-0">{{ selectedRequest.department_name }}</p>
        </div>

        <div>
            <p class="text-sm text-surface-500 mb-1">Запрашиваемые зоны:</p>
            <div class="flex flex-wrap gap-2">
                @for (zone of selectedRequest.requested_zone_names; track zone) {
                    <span class="bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 px-3 py-1 rounded-full text-sm">{{ zone }}</span>
                }
            </div>
        </div>

        <div>
            <p class="text-sm text-surface-500 mb-1">Причина:</p>
            <p class="text-surface-900 dark:text-surface-0 m-0">{{ selectedRequest.reason }}</p>
        </div>

        <div>
            <p class="text-sm text-surface-500 mb-1">Период:</p>
            <p class="text-surface-900 dark:text-surface-0 m-0">
                {{ formatDate(selectedRequest.valid_from) }}
                @if (selectedRequest.valid_until) {
                    — {{ formatDate(selectedRequest.valid_until) }}
                } @else {
                    — бессрочно
                }
            </p>
        </div>

        <div class="flex flex-col gap-2">
            <label class="font-medium text-surface-700 dark:text-surface-300">Причина отклонения (при отказе)</label>
            <textarea pTextarea [(ngModel)]="rejectionReason" rows="2" placeholder="Укажите причину отклонения..." class="w-full"></textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Отклонить" icon="pi pi-times" class="p-button-danger p-button-outlined" (click)="rejectRequest()"></button>
        <button pButton label="Одобрить" icon="pi pi-check" class="p-button-success" (click)="approveRequest()"></button>
    </ng-template>
</p-dialog>

<p-confirmdialog></p-confirmdialog>
