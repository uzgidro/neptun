<div class="card">
    <div class="font-semibold text-xl mb-4">Центр оценки компетенций</div>

    <!-- Статистика -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <p-card>
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-500 font-medium mb-1">Сессии</div>
                    <div class="text-2xl font-bold">{{ sessionsCount }}</div>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class="pi pi-calendar text-blue-600 text-xl"></i>
                </div>
            </div>
        </p-card>
        <p-card>
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-500 font-medium mb-1">Завершено</div>
                    <div class="text-2xl font-bold text-green-600">{{ completedSessionsCount }}</div>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class="pi pi-check-circle text-green-600 text-xl"></i>
                </div>
            </div>
        </p-card>
        <p-card>
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-500 font-medium mb-1">Оценки</div>
                    <div class="text-2xl font-bold">{{ assessmentsCount }}</div>
                </div>
                <div class="bg-purple-100 p-3 rounded-full">
                    <i class="pi pi-users text-purple-600 text-xl"></i>
                </div>
            </div>
        </p-card>
        <p-card>
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-500 font-medium mb-1">Планы развития</div>
                    <div class="text-2xl font-bold text-orange-600">{{ activePlansCount }}</div>
                </div>
                <div class="bg-orange-100 p-3 rounded-full">
                    <i class="pi pi-chart-line text-orange-600 text-xl"></i>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Вкладки -->
    <p-tabs [(value)]="activeTabIndex">
        <p-tablist>
            <p-tab [value]="0">Сессии оценки</p-tab>
            <p-tab [value]="1">Результаты оценки</p-tab>
            <p-tab [value]="2">Планы развития</p-tab>
        </p-tablist>
        <p-tabpanels>
        <!-- Вкладка: Сессии оценки -->
        <p-tabpanel [value]="0">
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg font-semibold">Ассессмент-центры</span>
                <button pButton (click)="openSessionDialog()" icon="pi pi-plus" label="Новая сессия"></button>
            </div>

            <p-accordion [multiple]="true">
                @for (session of sessions; track session.id) {
                    <p-accordion-panel>
                        <p-accordion-header>
                            <div class="flex items-center justify-between w-full pr-4">
                                <div class="flex items-center gap-3">
                                    <i class="pi pi-calendar text-xl"></i>
                                    <div>
                                        <div class="font-semibold">{{ session.name }}</div>
                                        <div class="text-sm text-gray-500">{{ session.session_date | date:'dd.MM.yyyy' }} | {{ session.location }}</div>
                                    </div>
                                </div>
                                <p-tag [value]="getSessionStatusLabel(session.status)" [severity]="getSessionStatusSeverity(session.status)"></p-tag>
                            </div>
                        </p-accordion-header>
                        <p-accordion-content>
                            <div class="p-4">
                                <!-- Информация о сессии -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <div class="text-500 font-medium mb-2">Время</div>
                                        <div>{{ session.start_time }} - {{ session.end_time }}</div>
                                    </div>
                                    <div>
                                        <div class="text-500 font-medium mb-2">Кандидаты</div>
                                        <div>{{ session.candidates.length }} человек</div>
                                    </div>
                                    <div>
                                        <div class="text-500 font-medium mb-2">Ассессоры</div>
                                        <div>{{ session.assessors.length }} человек</div>
                                    </div>
                                </div>

                                <!-- Компетенции для оценки -->
                                <div class="mb-4">
                                    <div class="text-500 font-medium mb-2">Компетенции для оценки</div>
                                    <div class="flex flex-wrap gap-2">
                                        @for (comp of session.competencies_to_assess; track comp.competency_id) {
                                            <p-tag [value]="comp.competency_name + ' (' + comp.weight + '%)'" severity="info"></p-tag>
                                        }
                                    </div>
                                </div>

                                <!-- Кандидаты -->
                                <div class="mb-4">
                                    <div class="text-500 font-medium mb-2">Кандидаты</div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="bg-surface-100 dark:bg-surface-700">
                                                    <th class="p-2 text-left">Сотрудник</th>
                                                    <th class="p-2 text-left">Должность</th>
                                                    <th class="p-2 text-left">Отдел</th>
                                                    <th class="p-2 text-center">Приглашение</th>
                                                    <th class="p-2 text-center">Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (candidate of session.candidates; track candidate.employee_id) {
                                                    <tr class="border-b">
                                                        <td class="p-2">{{ candidate.employee_name }}</td>
                                                        <td class="p-2">{{ candidate.position_name }}</td>
                                                        <td class="p-2">{{ candidate.department_name }}</td>
                                                        <td class="p-2 text-center">
                                                            @switch (candidate.invitation_status) {
                                                                @case ('accepted') {
                                                                    <p-tag value="Принято" severity="success"></p-tag>
                                                                }
                                                                @case ('pending') {
                                                                    <p-tag value="Ожидает" severity="warn"></p-tag>
                                                                }
                                                                @case ('declined') {
                                                                    <p-tag value="Отклонено" severity="danger"></p-tag>
                                                                }
                                                            }
                                                        </td>
                                                        <td class="p-2 text-center">
                                                            @if (session.status === 'completed') {
                                                                <button pButton icon="pi pi-file" class="p-button-rounded p-button-text p-button-sm"
                                                                        pTooltip="Сформировать оценку" (click)="generateAssessment(session, candidate)"></button>
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Блоки оценки -->
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="text-500 font-medium">Блоки оценки</div>
                                        @if (session.status === 'planning' || session.status === 'scheduled') {
                                            <button pButton icon="pi pi-plus" label="Добавить блок"
                                                    class="p-button-sm p-button-outlined" (click)="openBlockDialog(session)"></button>
                                        }
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        @for (block of session.assessment_blocks; track block.id) {
                                            <div class="border rounded-lg p-3">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center gap-2">
                                                        <i [class]="getBlockTypeIcon(block.block_type) + ' text-lg'"></i>
                                                        <span class="font-medium">{{ block.name }}</span>
                                                    </div>
                                                    @switch (block.status) {
                                                        @case ('completed') {
                                                            <p-tag value="Завершен" severity="success"></p-tag>
                                                        }
                                                        @case ('in_progress') {
                                                            <p-tag value="В процессе" severity="info"></p-tag>
                                                        }
                                                        @case ('pending') {
                                                            <p-tag value="Ожидает" severity="secondary"></p-tag>
                                                        }
                                                    }
                                                </div>
                                                <div class="text-sm text-gray-500 mb-2">
                                                    {{ getBlockTypeLabel(block.block_type) }} | {{ block.duration_minutes }} мин
                                                </div>
                                                @if (block.description) {
                                                    <div class="text-sm mb-2">{{ block.description }}</div>
                                                }
                                                <div class="flex gap-2 mt-2">
                                                    @if (session.status === 'in_progress' && block.status !== 'completed') {
                                                        @for (candidate of session.candidates; track candidate.employee_id) {
                                                            <button pButton [label]="'Оценить: ' + candidate.employee_name.split(' ')[0]"
                                                                    class="p-button-sm p-button-outlined"
                                                                    (click)="openEvaluationDialog(session, candidate, block)"></button>
                                                        }
                                                        <button pButton icon="pi pi-check" label="Завершить блок"
                                                                class="p-button-sm p-button-success"
                                                                (click)="completeBlock(session, block)"></button>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <!-- Действия с сессией -->
                                <div class="flex gap-2 mt-4 pt-4 border-t">
                                    @switch (session.status) {
                                        @case ('planning') {
                                            <button pButton icon="pi pi-send" label="Отправить приглашения"
                                                    class="p-button-outlined" (click)="sendInvitations(session)"></button>
                                            <button pButton icon="pi pi-pencil" label="Редактировать"
                                                    class="p-button-outlined p-button-warning" (click)="openEditSessionDialog(session)"></button>
                                        }
                                        @case ('scheduled') {
                                            <button pButton icon="pi pi-play" label="Начать сессию"
                                                    class="p-button-success" (click)="startSession(session)"></button>
                                            <button pButton icon="pi pi-pencil" label="Редактировать"
                                                    class="p-button-outlined p-button-warning" (click)="openEditSessionDialog(session)"></button>
                                        }
                                        @case ('in_progress') {
                                            <button pButton icon="pi pi-check" label="Завершить сессию"
                                                    class="p-button-success" (click)="completeSession(session)"></button>
                                        }
                                    }
                                    <button pButton icon="pi pi-trash" label="Удалить"
                                            class="p-button-outlined p-button-danger" (click)="openDeleteSessionDialog(session)"></button>
                                </div>
                            </div>
                        </p-accordion-content>
                    </p-accordion-panel>
                }
            </p-accordion>

            @if (sessions.length === 0) {
                <div class="text-center py-8 text-gray-500">
                    <i class="pi pi-calendar text-4xl mb-2"></i>
                    <p>Нет запланированных сессий</p>
                </div>
            }
        </p-tabpanel>

        <!-- Вкладка: Результаты оценки -->
        <p-tabpanel [value]="1">
            <p-table
                #dtAssessments
                [value]="assessments"
                dataKey="id"
                [rows]="10"
                [loading]="loading"
                [rowHover]="true"
                [showGridlines]="true"
                [paginator]="true"
                [globalFilterFields]="['employee_name', 'department_name', 'status']"
            >
                <ng-template #caption>
                    <div class="flex justify-between items-center">
                        <p-iconfield>
                            <p-inputicon><i class="pi pi-search"></i></p-inputicon>
                            <input pInputText type="text" (input)="onGlobalFilter(dtAssessments, $event)" placeholder="Поиск" />
                        </p-iconfield>
                    </div>
                </ng-template>
                <ng-template #header>
                    <tr>
                        <th pSortableColumn="employee_name" style="min-width: 14rem">Сотрудник</th>
                        <th style="min-width: 10rem">Должность</th>
                        <th style="min-width: 10rem">Отдел</th>
                        <th style="min-width: 8rem">Дата</th>
                        <th style="min-width: 8rem">Общий балл</th>
                        <th style="min-width: 8rem">Статус</th>
                        <th style="width: 14rem">Действия</th>
                    </tr>
                </ng-template>
                <ng-template #body let-assessment>
                    <tr>
                        <td>
                            <div class="font-medium">{{ assessment.employee_name }}</div>
                        </td>
                        <td>{{ assessment.position_name }}</td>
                        <td>{{ assessment.department_name }}</td>
                        <td>{{ assessment.assessment_date | date:'dd.MM.yyyy' }}</td>
                        <td>
                            @if (assessment.overall_score) {
                                <span [class]="'font-bold ' + getScoreColor(assessment.overall_score)">
                                    {{ assessment.overall_score.toFixed(1) }}
                                </span>
                            } @else {
                                —
                            }
                        </td>
                        <td>
                            <p-tag [value]="getStatusLabel(assessment.status)" [severity]="getStatusSeverity(assessment.status)"></p-tag>
                        </td>
                        <td>
                            <div class="flex gap-1">
                                <button pButton icon="pi pi-eye" class="p-button-rounded p-button-text p-button-info"
                                        pTooltip="Просмотр отчета" (click)="viewReport(assessment)"></button>
                                @if (assessment.status === 'completed') {
                                    <button pButton icon="pi pi-check" class="p-button-rounded p-button-text p-button-success"
                                            pTooltip="Утвердить" (click)="approveAssessment(assessment)"></button>
                                }
                                @if (assessment.status === 'approved') {
                                    <button pButton icon="pi pi-chart-line" class="p-button-rounded p-button-text p-button-warning"
                                            pTooltip="Создать план развития" (click)="openPlanDialog(assessment)"></button>
                                }
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template #emptymessage>
                    <tr>
                        <td colspan="7" class="text-center py-4">Нет результатов оценки</td>
                    </tr>
                </ng-template>
            </p-table>
        </p-tabpanel>

        <!-- Вкладка: Планы развития -->
        <p-tabpanel [value]="2">
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg font-semibold">Индивидуальные планы развития</span>
                <button pButton (click)="openPlanDialog()" icon="pi pi-plus" label="Новый план"></button>
            </div>

            <p-table
                #dtPlans
                [value]="developmentPlans"
                dataKey="id"
                [rows]="10"
                [loading]="loading"
                [rowHover]="true"
                [showGridlines]="true"
                [paginator]="true"
                [globalFilterFields]="['employee_name', 'status']"
            >
                <ng-template #header>
                    <tr>
                        <th pSortableColumn="employee_name" style="min-width: 14rem">Сотрудник</th>
                        <th style="min-width: 10rem">Период</th>
                        <th style="min-width: 10rem">Компетенции</th>
                        <th style="min-width: 10rem">Прогресс</th>
                        <th style="min-width: 8rem">Статус</th>
                        <th style="width: 12rem">Действия</th>
                    </tr>
                </ng-template>
                <ng-template #body let-plan>
                    <tr>
                        <td>
                            <div class="font-medium">{{ plan.employee_name }}</div>
                        </td>
                        <td>
                            <div>{{ plan.start_date | date:'dd.MM.yyyy' }}</div>
                            <div class="text-sm text-gray-500">{{ plan.end_date | date:'dd.MM.yyyy' }}</div>
                        </td>
                        <td>
                            <div class="flex flex-wrap gap-1">
                                @for (target of plan.competency_targets; track target.competency_id) {
                                    <p-tag [value]="target.competency_name" severity="info" class="text-xs"></p-tag>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <p-progressbar [value]="plan.overall_progress" [showValue]="false" class="flex-1" style="height: 8px"></p-progressbar>
                                <span class="text-sm font-medium">{{ plan.overall_progress }}%</span>
                            </div>
                        </td>
                        <td>
                            <p-tag [value]="getPlanStatusLabel(plan.status)" [severity]="getPlanStatusSeverity(plan.status)"></p-tag>
                        </td>
                        <td>
                            <div class="flex gap-1">
                                <button pButton icon="pi pi-eye" class="p-button-rounded p-button-text p-button-info"
                                        pTooltip="Детали" (click)="viewPlanDetails(plan)"></button>
                                @if (plan.status === 'draft') {
                                    <button pButton icon="pi pi-play" class="p-button-rounded p-button-text p-button-success"
                                            pTooltip="Активировать" (click)="activatePlan(plan)"></button>
                                }
                                @if (plan.status === 'active') {
                                    <button pButton icon="pi pi-check" class="p-button-rounded p-button-text p-button-success"
                                            pTooltip="Завершить" (click)="completePlan(plan)"></button>
                                }
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template #emptymessage>
                    <tr>
                        <td colspan="6" class="text-center py-4">Нет планов развития</td>
                    </tr>
                </ng-template>
            </p-table>
        </p-tabpanel>
        </p-tabpanels>
    </p-tabs>
</div>

<!-- Диалог создания/редактирования сессии -->
<p-dialog [(visible)]="displaySessionDialog" [header]="isEditMode ? 'Редактировать сессию' : 'Новая сессия оценки'"
          [modal]="true" [style]="{ width: '700px' }" [closable]="true">
    <form [formGroup]="sessionForm" class="p-4">
        <div class="mb-4">
            <label class="block font-medium mb-2">Название сессии *</label>
            <input pInputText formControlName="name" class="w-full" placeholder="Например: Ассессмент-центр Q1 2025" />
            @if (submitted && sessionForm.get('name')?.errors?.['required']) {
                <small class="text-red-500">Название обязательно</small>
            }
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Описание</label>
            <textarea pTextarea formControlName="description" class="w-full" rows="2"
                      placeholder="Цель и описание сессии"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label class="block font-medium mb-2">Дата *</label>
                <p-datepicker formControlName="session_date" [showIcon]="true" dateFormat="dd.mm.yy" class="w-full"></p-datepicker>
            </div>
            <div>
                <label class="block font-medium mb-2">Начало *</label>
                <input pInputText formControlName="start_time" class="w-full" placeholder="09:00" />
            </div>
            <div>
                <label class="block font-medium mb-2">Окончание *</label>
                <input pInputText formControlName="end_time" class="w-full" placeholder="18:00" />
            </div>
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Место проведения</label>
            <input pInputText formControlName="location" class="w-full" placeholder="Конференц-зал" />
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Компетенции для оценки *</label>
            <p-multiselect formControlName="competencies" [options]="standardCompetencies" optionLabel="name"
                           placeholder="Выберите компетенции" class="w-full" [showClear]="true"></p-multiselect>
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Кандидаты (сотрудники) *</label>
            <p-multiselect formControlName="candidates" [options]="employees" optionLabel="name"
                           placeholder="Выберите сотрудников" class="w-full" [showClear]="true"></p-multiselect>
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Ассессоры (оценщики) *</label>
            <p-multiselect formControlName="assessors" [options]="assessors" optionLabel="name"
                           placeholder="Выберите ассессоров" class="w-full" [showClear]="true"></p-multiselect>
        </div>
    </form>
    <ng-template #footer>
        <button pButton label="Отмена" class="p-button-text" (click)="displaySessionDialog = false"></button>
        <button pButton label="Сохранить" (click)="saveSession()"></button>
    </ng-template>
</p-dialog>

<!-- Диалог добавления блока оценки -->
<p-dialog [(visible)]="displayBlockDialog" header="Добавить блок оценки"
          [modal]="true" [style]="{ width: '500px' }" [closable]="true">
    <form [formGroup]="blockForm" class="p-4">
        <div class="mb-4">
            <label class="block font-medium mb-2">Тип блока *</label>
            <p-select formControlName="block_type" [options]="blockTypes" optionLabel="label"
                        placeholder="Выберите тип" class="w-full"></p-select>
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Название *</label>
            <input pInputText formControlName="name" class="w-full" placeholder="Название блока" />
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Описание</label>
            <textarea pTextarea formControlName="description" class="w-full" rows="2"></textarea>
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Длительность (мин) *</label>
            <p-inputnumber formControlName="duration_minutes" [min]="15" [max]="480" class="w-full"></p-inputnumber>
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Оцениваемые компетенции *</label>
            <p-multiselect formControlName="competencies" [options]="standardCompetencies" optionLabel="name"
                           placeholder="Выберите компетенции" class="w-full"></p-multiselect>
        </div>
    </form>
    <ng-template #footer>
        <button pButton label="Отмена" class="p-button-text" (click)="displayBlockDialog = false"></button>
        <button pButton label="Добавить" (click)="saveBlock()"></button>
    </ng-template>
</p-dialog>

<!-- Диалог оценки кандидата -->
<p-dialog [(visible)]="displayEvaluationDialog" header="Оценка кандидата"
          [modal]="true" [style]="{ width: '600px' }" [closable]="true">
    @if (evaluatingCandidate && evaluatingBlock && selectedSession) {
        <div class="p-4">
            <div class="mb-4 p-3 bg-surface-100 dark:bg-surface-700 rounded-lg">
                <div class="font-semibold">{{ evaluatingCandidate.employee_name }}</div>
                <div class="text-sm text-gray-500">{{ evaluatingBlock.name }}</div>
            </div>

            <div class="mb-4">
                <div class="font-medium mb-3">Оценка компетенций (1-5 баллов)</div>
                @for (comp of selectedSession.competencies_to_assess; track comp.competency_id) {
                    <div class="mb-4 p-3 border rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium">{{ comp.competency_name }}</span>
                            <p-tag [value]="getCategoryLabel(comp.category)" severity="info" class="text-xs"></p-tag>
                        </div>
                        <div class="flex items-center gap-4 mb-2">
                            <p-rating [(ngModel)]="candidateScores[comp.competency_id]" [stars]="5"></p-rating>
                            <span class="text-lg font-bold">{{ candidateScores[comp.competency_id] }}</span>
                        </div>
                        <input pInputText [(ngModel)]="candidateNotes[comp.competency_id]" class="w-full text-sm"
                               placeholder="Комментарий к оценке" />
                    </div>
                }
            </div>

            <form [formGroup]="evaluationForm">
                <div class="mb-4">
                    <label class="block font-medium mb-2">Общие заметки</label>
                    <textarea pTextarea formControlName="general_notes" class="w-full" rows="3"
                              placeholder="Общие наблюдения по кандидату"></textarea>
                </div>
            </form>
        </div>
    }
    <ng-template #footer>
        <button pButton label="Отмена" class="p-button-text" (click)="displayEvaluationDialog = false"></button>
        <button pButton label="Сохранить оценку" (click)="saveEvaluation()"></button>
    </ng-template>
</p-dialog>

<!-- Диалог отчета по оценке -->
<p-dialog [(visible)]="displayReportDialog" header="Отчет по оценке компетенций"
          [modal]="true" [style]="{ width: '800px' }" [closable]="true" [maximizable]="true">
    @if (currentReport) {
        <div class="p-4">
            <!-- Заголовок отчета -->
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-2">{{ currentReport.employee_name }}</h2>
                <div class="text-gray-500">{{ currentReport.position_name }} | {{ currentReport.department_name }}</div>
                <div class="text-sm text-gray-400">Дата оценки: {{ currentReport.assessment_date | date:'dd.MM.yyyy' }}</div>
            </div>

            <!-- Общий балл -->
            <div class="flex justify-center mb-6">
                <div class="text-center">
                    <p-knob [(ngModel)]="currentReport.overall_score" [readonly]="true" [min]="0" [max]="5"
                            [size]="150" valueColor="#22c55e" rangeColor="#e5e7eb"></p-knob>
                    <div class="text-lg font-semibold mt-2">Общий балл: {{ currentReport.overall_score.toFixed(1) }} / 5</div>
                </div>
            </div>

            <!-- Оценки по компетенциям -->
            <div class="mb-6">
                <h3 class="font-semibold mb-3">Оценки по компетенциям</h3>
                <div class="space-y-3">
                    @for (result of currentReport.competency_results; track result.competency_id) {
                        <div class="flex items-center gap-3">
                            <div class="w-40 font-medium">{{ result.competency_name }}</div>
                            <div class="flex-1">
                                <p-progressbar [value]="result.percentage" [showValue]="false" style="height: 12px"></p-progressbar>
                            </div>
                            <div class="w-16 text-right font-bold" [class]="getScoreColor(result.score)">
                                {{ result.score.toFixed(1) }}
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Сильные стороны -->
            @if (currentReport.strengths.length > 0) {
                <div class="mb-6">
                    <h3 class="font-semibold mb-3 text-green-600"><i class="pi pi-check-circle mr-2"></i>Сильные стороны</h3>
                    <ul class="list-disc list-inside space-y-1">
                        @for (strength of currentReport.strengths; track strength.competency_id) {
                            <li>{{ strength.competency_name }}</li>
                        }
                    </ul>
                </div>
            }

            <!-- Области развития -->
            @if (currentReport.development_areas.length > 0) {
                <div class="mb-6">
                    <h3 class="font-semibold mb-3 text-orange-600"><i class="pi pi-exclamation-triangle mr-2"></i>Области развития</h3>
                    <div class="space-y-2">
                        @for (area of currentReport.development_areas; track area.competency_id) {
                            <div class="p-3 border rounded-lg">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-medium">{{ area.competency_name }}</span>
                                    <p-tag [value]="area.priority === 'high' ? 'Высокий' : 'Средний'"
                                           [severity]="area.priority === 'high' ? 'danger' : 'warn'"></p-tag>
                                </div>
                                <div class="text-sm text-gray-500">
                                    Текущий: {{ area.current_level }} | Целевой: {{ area.target_level }} | Разрыв: {{ area.gap }}
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Рекомендации -->
            <div class="mb-4">
                <h3 class="font-semibold mb-3"><i class="pi pi-lightbulb mr-2"></i>Карьерные рекомендации</h3>
                <div class="p-3 bg-blue-50 rounded-lg">{{ currentReport.career_recommendations }}</div>
            </div>
        </div>
    }
    <ng-template #footer>
        <button pButton label="Закрыть" (click)="displayReportDialog = false"></button>
    </ng-template>
</p-dialog>

<!-- Диалог создания плана развития -->
<p-dialog [(visible)]="displayPlanDialog" header="Новый план развития"
          [modal]="true" [style]="{ width: '600px' }" [closable]="true">
    <form [formGroup]="planForm" class="p-4">
        <div class="mb-4">
            <label class="block font-medium mb-2">Сотрудник *</label>
            <p-select formControlName="employee_id" [options]="employees" optionLabel="name"
                        placeholder="Выберите сотрудника" class="w-full"></p-select>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block font-medium mb-2">Дата начала *</label>
                <p-datepicker formControlName="start_date" [showIcon]="true" dateFormat="dd.mm.yy" class="w-full"></p-datepicker>
            </div>
            <div>
                <label class="block font-medium mb-2">Дата окончания *</label>
                <p-datepicker formControlName="end_date" [showIcon]="true" dateFormat="dd.mm.yy" class="w-full"></p-datepicker>
            </div>
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-2">Примечания</label>
            <textarea pTextarea formControlName="notes" class="w-full" rows="3"
                      placeholder="Цели и особенности плана развития"></textarea>
        </div>
    </form>
    <ng-template #footer>
        <button pButton label="Отмена" class="p-button-text" (click)="displayPlanDialog = false"></button>
        <button pButton label="Создать" (click)="savePlan()"></button>
    </ng-template>
</p-dialog>

<!-- Диалог мониторинга плана развития -->
<p-dialog [(visible)]="displayMonitoringDialog" header="Мониторинг плана развития"
          [modal]="true" [style]="{ width: '900px' }" [closable]="true" [maximizable]="true">
    @if (selectedPlan) {
        <div class="p-4">
            <!-- Заголовок -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-bold">{{ selectedPlan.employee_name }}</h2>
                    <div class="text-gray-500">{{ selectedPlan.start_date | date:'dd.MM.yyyy' }} - {{ selectedPlan.end_date | date:'dd.MM.yyyy' }}</div>
                </div>
                <div class="text-center">
                    <p-knob [(ngModel)]="selectedPlan.overall_progress" [readonly]="true" [min]="0" [max]="100"
                            [size]="100" valueColor="#3b82f6" rangeColor="#e5e7eb" valueTemplate="{value}%"></p-knob>
                    <div class="text-sm font-medium">Общий прогресс</div>
                </div>
            </div>

            <!-- Целевые компетенции -->
            <div class="mb-6">
                <h3 class="font-semibold mb-3">Целевые компетенции</h3>
                <div class="space-y-3">
                    @for (target of selectedPlan.competency_targets; track target.competency_id) {
                        <div class="p-3 border rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium">{{ target.competency_name }}</span>
                                <span class="text-sm">{{ target.current_level }} → {{ target.target_level }}</span>
                            </div>
                            <p-progressbar [value]="target.progress" [showValue]="true" style="height: 20px"></p-progressbar>
                        </div>
                    }
                </div>
            </div>

            <!-- Мероприятия -->
            <div class="mb-6">
                <h3 class="font-semibold mb-3">Мероприятия по развитию</h3>
                <p-timeline [value]="selectedPlan.development_activities">
                    <ng-template #content let-activity>
                        <div class="p-3 border rounded-lg mb-2">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium">{{ activity.title }}</span>
                                @switch (activity.status) {
                                    @case ('completed') {
                                        <p-tag value="Завершено" severity="success"></p-tag>
                                    }
                                    @case ('in_progress') {
                                        <p-tag value="В процессе" severity="info"></p-tag>
                                    }
                                    @case ('planned') {
                                        <p-tag value="Запланировано" severity="secondary"></p-tag>
                                    }
                                }
                            </div>
                            <div class="text-sm text-gray-500">{{ getActivityTypeLabel(activity.activity_type) }}</div>
                            @if (activity.description) {
                                <div class="text-sm mt-1">{{ activity.description }}</div>
                            }
                        </div>
                    </ng-template>
                </p-timeline>
            </div>

            <!-- Наставники -->
            @if (selectedPlan.mentors.length > 0) {
                <div class="mb-6">
                    <h3 class="font-semibold mb-3">Наставники</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        @for (mentor of selectedPlan.mentors; track mentor.mentor_id) {
                            <div class="p-3 border rounded-lg flex items-center gap-3">
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <i class="pi pi-user text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="font-medium">{{ mentor.mentor_name }}</div>
                                    <div class="text-sm text-gray-500">{{ mentor.mentor_position }}</div>
                                    <div class="text-xs text-gray-400">{{ mentor.meeting_frequency }}</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Промежуточные оценки -->
            @if (selectedPlan.interim_assessments.length > 0) {
                <div>
                    <h3 class="font-semibold mb-3">Промежуточные оценки</h3>
                    @for (interim of selectedPlan.interim_assessments; track interim.id) {
                        <div class="p-3 border rounded-lg mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium">{{ interim.assessment_date | date:'dd.MM.yyyy' }}</span>
                                <span class="text-sm">Прогресс: {{ interim.overall_progress }}%</span>
                            </div>
                            <div class="text-sm mb-2">{{ interim.feedback }}</div>
                            <div class="flex flex-wrap gap-2">
                                @for (score of interim.competency_scores; track score.competency_id) {
                                    <p-tag [value]="score.competency_name + ': ' + score.score" severity="info"></p-tag>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
    <ng-template #footer>
        <button pButton label="Закрыть" (click)="displayMonitoringDialog = false"></button>
    </ng-template>
</p-dialog>

<!-- Диалог подтверждения удаления -->
<app-delete-confirmation
    [(visible)]="displayDeleteDialog"
    [message]="'Вы уверены, что хотите удалить сессию ' + (selectedSession?.name || '') + '?'"
    (onConfirm)="confirmDelete()">
</app-delete-confirmation>
