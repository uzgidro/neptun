<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">{{ 'PLANNING.EVENTS.TITLE' | translate }}</h2>
        <p-button
            [label]="'PLANNING.EVENTS.NEW' | translate"
            icon="pi pi-plus"
            (onClick)="openCreateDialog()"
        ></p-button>
    </div>

    <!-- Filters -->
    <!--    <div class="mb-4 p-4 bg-gray-50 rounded">-->
    <!--        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">-->
    <!--            <app-select-->
    <!--                [items]="eventStatuses"-->
    <!--                optionLabel="name"-->
    <!--                placeholder="Статус"-->
    <!--                formControlName="statusId"-->
    <!--            ></app-select>-->

    <!--            <p-dropdown-->
    <!--                [options]="eventTypes"-->
    <!--                optionLabel="name"-->
    <!--                placeholder="Тип"-->
    <!--                [formControl]="filterForm.controls['typeId']"-->
    <!--                [showClear]="true"-->
    <!--            ></p-dropdown>-->

    <!--            <p-dropdown-->
    <!--                [options]="organizations"-->
    <!--                optionLabel="name"-->
    <!--                placeholder="Организация"-->
    <!--                [formControl]="filterForm.controls['organizationId']"-->
    <!--                [showClear]="true"-->
    <!--            ></p-dropdown>-->

    <!--            <p-calendar-->
    <!--                placeholder="Дата от"-->
    <!--                [formControl]="filterForm.controls['dateFrom']"-->
    <!--                dateFormat="dd.mm.yy"-->
    <!--                [showIcon]="true"-->
    <!--                [showClear]="true"-->
    <!--            ></p-calendar>-->

    <!--            <p-calendar-->
    <!--                placeholder="Дата до"-->
    <!--                [formControl]="filterForm.controls['dateTo']"-->
    <!--                dateFormat="dd.mm.yy"-->
    <!--                [showIcon]="true"-->
    <!--                [showClear]="true"-->
    <!--            ></p-calendar>-->
    <!--        </div>-->

    <!--        <div class="flex gap-2 mt-3">-->
    <!--            <p-button-->
    <!--                label="Применить"-->
    <!--                icon="pi pi-filter"-->
    <!--                (onClick)="applyFilters()"-->
    <!--                [outlined]="true"-->
    <!--            ></p-button>-->
    <!--            <p-button-->
    <!--                label="Очистить"-->
    <!--                icon="pi pi-times"-->
    <!--                (onClick)="clearFilters()"-->
    <!--                [outlined]="true"-->
    <!--                severity="secondary"-->
    <!--            ></p-button>-->
    <!--        </div>-->
    <!--    </div>-->

    <!-- Data Table -->
    <p-table
        [value]="events()"
        [loading]="loading()"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]"
        [showCurrentPageReport]="true"
        [scrollable]="true"
        [currentPageReportTemplate]="'PLANNING.COMMON.PAGE_REPORT' | translate"
        [globalFilterFields]="['name', 'description', 'location', 'responsible_contact.name']"
    >
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="name">{{ 'PLANNING.COMMON.NAME' | translate }}
                    <p-sortIcon field="name"></p-sortIcon>
                </th>
                <th pSortableColumn="event_type.name">{{ 'PLANNING.EVENTS.TYPE' | translate }}
                    <p-sortIcon field="event_type.name"></p-sortIcon>
                </th>
                <th pSortableColumn="event_status.name">{{ 'PLANNING.COMMON.STATUS' | translate }}
                    <p-sortIcon field="event_status.name"></p-sortIcon>
                </th>
                <th pSortableColumn="event_date">{{ 'PLANNING.COMMON.DATE' | translate }}
                    <p-sortIcon field="event_date"></p-sortIcon>
                </th>
                <th>{{ 'PLANNING.EVENTS.LOCATION' | translate }}</th>
                <th>{{ 'PLANNING.EVENTS.ORGANIZATION' | translate }}</th>
                <th>{{ 'PLANNING.EVENTS.RESPONSIBLE' | translate }}</th>
                <th>{{ 'PLANNING.EVENTS.FILES' | translate }}</th>
                <th style="width: 150px">{{ 'PLANNING.COMMON.ACTIONS' | translate }}</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-event>
            <tr>
                <td>{{ event.name }}</td>
                <td>
                    <p-tag
                        [value]="event.event_type?.name || 'N/A'"
                        severity="info"
                    ></p-tag>
                </td>
                <td>
                    <p-tag
                        [value]="event.event_status?.name || 'N/A'"
                        [severity]="getStatusSeverity(event.event_status_id)"
                    ></p-tag>
                </td>
                <td>{{ formatDate(event.event_date) }}</td>
                <td>{{ event.location || '—' }}</td>
                <td>{{ event.organization?.name || '—' }}</td>
                <td>{{ event.responsible_contact?.name || '—' }}</td>
                <td>
                    @if (event.files && event.files.length > 0) {
                        <p-button
                            [label]="event.files.length.toString()"
                            icon="pi pi-paperclip"
                            severity="secondary"
                            [text]="true"
                            (click)="showFiles(event)"
                            [pTooltip]="'PLANNING.EVENTS.VIEW_FILES' | translate"
                        />
                    } @else {
                        <span class="text-color-secondary">—</span>
                    }
                </td>
                <td>
                    <div class="flex gap-2">
                        <p-button
                            icon="pi pi-pencil"
                            [rounded]="true"
                            [text]="true"
                            (onClick)="openEditDialog(event)"
                            [pTooltip]="'PLANNING.COMMON.EDIT' | translate"
                        ></p-button>
                        <p-button
                            icon="pi pi-trash"
                            [rounded]="true"
                            [text]="true"
                            severity="danger"
                            (onClick)="deleteEvent(event)"
                            [pTooltip]="'PLANNING.COMMON.DELETE' | translate"
                        ></p-button>
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="9" class="text-center py-4">{{ 'PLANNING.EVENTS.NO_EVENTS' | translate }}</td>
            </tr>
        </ng-template>
    </p-table>
</div>

<!-- Create/Edit Dialog -->
<app-dialog
    [header]="isEditMode() ? ('PLANNING.EVENTS.EDIT' | translate) : ('PLANNING.EVENTS.NEW' | translate)"
    [(visible)]="displayDialog"
    [form]="eventForm"
    [saveLabel]="isEditMode() ? ('PLANNING.COMMON.SAVE' | translate) : ('PLANNING.COMMON.CREATE' | translate)"
    (save)="onSubmit()"
    (cancel)="closeDialog()"
>
    <form class="p-4" [formGroup]="eventForm" (ngSubmit)="onSubmit()">
        <div class="grid grid-cols-1 gap-4">
            <!-- Name -->
            <app-input-text
                [label]="'PLANNING.COMMON.NAME' | translate"
                formControlName="name"
                [submitted]="submitted"
                [required]="true"
                [errorMessage]="'PLANNING.COMMON.NAME_REQUIRED' | translate"
            ></app-input-text>

            <!-- Description -->
            <app-textarea
                [label]="'PLANNING.COMMON.DESCRIPTION' | translate"
                formControlName="description"
                [rows]="3"
                [required]="false"
            ></app-textarea>

            <!-- Location -->
            <app-input-text
                [label]="'PLANNING.EVENTS.LOCATION' | translate"
                formControlName="location"
                [required]="false"
            ></app-input-text>

            <!-- Event Date -->
            <app-date-picker
                [label]="'PLANNING.EVENTS.DATE_TIME' | translate"
                formControlName="event_date"
                [submitted]="submitted"
                [showTime]="true"
                [errorMessage]="'PLANNING.COMMON.DATE_REQUIRED' | translate"
            ></app-date-picker>

            <!-- Event Type -->
            <app-select
                [label]="'PLANNING.EVENTS.EVENT_TYPE' | translate"
                formControlName="event_type_id"
                [items]="eventTypes"
                [submitted]="submitted"
                [errorMessage]="'PLANNING.EVENTS.EVENT_TYPE_REQUIRED' | translate"
            ></app-select>

            <!-- Event Status (only for edit) -->
            @if (isEditMode()) {
                <app-select
                    [label]="'PLANNING.EVENTS.EVENT_STATUS' | translate"
                    formControlName="event_status_id"
                    [items]="eventStatuses"
                    [submitted]="false"
                ></app-select>
            }

            <!-- Organization -->
            <app-select
                [label]="'PLANNING.EVENTS.ORGANIZATION' | translate"
                formControlName="organization_id"
                [items]="organizations"
                [submitted]="false"
            ></app-select>

            <!-- Responsible Contact -->
            <div class="field">
                <div class="flex justify-between items-center mb-2">
                    <label class="font-semibold">
                        {{ 'PLANNING.EVENTS.RESPONSIBLE_PERSON' | translate }} <span class="text-red-500">*</span>
                    </label>
                    <p-button
                        [label]="showCreateContact ? ('PLANNING.EVENTS.SELECT_EXISTING' | translate) : ('PLANNING.EVENTS.CREATE_NEW' | translate)"
                        icon="pi pi-refresh"
                        (onClick)="toggleContactMode()"
                        [text]="true"
                        size="small"
                    ></p-button>
                </div>

                <!-- Autocomplete for existing contact -->
                @if (!showCreateContact) {
                    <p-autoComplete
                        formControlName="responsible_contact"
                        [suggestions]="filteredContacts"
                        (completeMethod)="searchContacts($event)"
                        optionLabel="name"
                        [placeholder]="'PLANNING.EVENTS.START_TYPING_NAME' | translate"
                        [dropdown]="true"
                        class="w-full"
                        [appendTo]="'body'"
                        [class.ng-invalid]="submitted && !showCreateContact"
                    ></p-autoComplete>
                }

                <!-- Create new contact -->
                @if (showCreateContact) {
                    <div class="grid grid-cols-2 gap-3">
                        <app-input-text
                            [label]="'PLANNING.EVENTS.FIO' | translate"
                            formControlName="responsible_fio"
                            [submitted]="submitted"
                            [required]="true"
                            [errorMessage]="'PLANNING.EVENTS.FIO_REQUIRED' | translate"
                        ></app-input-text>
                        <app-input-text
                            [label]="'PLANNING.EVENTS.PHONE' | translate"
                            formControlName="responsible_phone"
                            [submitted]="submitted"
                            [required]="true"
                            [errorMessage]="'PLANNING.EVENTS.PHONE_REQUIRED' | translate"
                        ></app-input-text>
                    </div>
                }
            </div>

            <!-- Existing Files (Edit Mode) -->
            @if (isEditMode() && selectedEvent?.files && (selectedEvent?.files?.length ?? 0) > 0) {
                <app-file-list
                    [files]="selectedEvent?.files || []"
                    (removeFile)="removeExistingFile($event)">
                </app-file-list>
            }

            <app-file-upload
                [label]="isEditMode() ? ('PLANNING.EVENTS.ADD_NEW_FILES' | translate) : ('PLANNING.EVENTS.ATTACH_FILES' | translate)"
                [files]="selectedFiles"
                (filesChange)="onFileSelect($event)"
                (removeFile)="removeFile($event)">
            </app-file-upload>
        </div>
    </form>
</app-dialog>

<!-- File Viewer Dialog -->
<app-file-viewer
    [(visible)]="showFilesDialog"
    [header]="'PLANNING.EVENTS.EVENT_FILES' | translate"
    [files]="selectedEventForFiles?.files || []">
</app-file-viewer>

<!-- Toast for notifications -->
<p-toast></p-toast>

<!-- Confirmation dialog -->
<p-confirmDialog></p-confirmDialog>
