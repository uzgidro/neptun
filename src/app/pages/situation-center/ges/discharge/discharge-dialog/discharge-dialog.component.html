<p-dialog
    [(visible)]="display"
    [header]="isEditMode ? 'Редактировать водосброс' : 'Добавить водосброс'"
    [modal]="true"
    styleClass="p-fluid"
    [breakpoints]="{ '960px': '75vw' }"
    [style]="{ width: '30vw' }"
    (onHide)="closeDialog()"
>
    <ng-template pTemplate="content">
        <form [formGroup]="waterDischargeForm" (ngSubmit)="onSubmit()">
            <div class="field">
                <p-floatlabel>
                    <p-select
                        id="organization"
                        [options]="organizations"
                        formControlName="organization"
                        optionLabel="name"
                        [loading]="loading"
                        [disabled]="isEditMode"
                        [showClear]="true"
                        [group]="true"
                        [filter]="true"
                        [appendTo]="'body'"
                        [style]="{ width: '100%' }"
                        [required]="true"
                        [ngClass]="{ 'ng-invalid ng-dirty': submitted && waterDischargeForm.controls['organization'].errors }"
                    >
                        <ng-template let-group pTemplate="group">
                            <div class="flex items-center">
                                <span>{{ group.name }}</span>
                            </div>
                        </ng-template>
                    </p-select>
                    <label for="organization">Организация</label>
                </p-floatlabel>
                @if (submitted && waterDischargeForm.controls['organization'].errors) {
                    <p-message severity="error">Организация обязательна</p-message>
                }
            </div>

            <div class="grid xl:grid-cols-2 xl:gap-4">
                <div>
                    <p-floatlabel class="w-full my-4" variant="on">
                        <p-date-picker class="w-full"
                                       inputId="started_at"
                                       formControlName="started_at"
                                       dateFormat="dd.mm.yy"
                                       [disabled]="isEditMode"
                                       [showClear]="true"
                                       [invalid]="submitted && waterDischargeForm.controls['started_at'].invalid"
                                       [appendTo]="'body'"
                                       [showTime]="true"
                                       [hourFormat]="'24'"
                                       [maxDate]="maxDate" />
                        <label for="started_at">Начало сброса</label>
                    </p-floatlabel>

                    @if (submitted && waterDischargeForm.controls['started_at'].errors?.['required']) {
                        <p-message severity="error" variant="simple" size="small">Укажите начало сброса.</p-message>
                    }
                </div>

                <div>
                    <p-floatlabel class="w-full my-4" variant="on">
                        <p-date-picker class="w-full"
                                       inputId="ended_at"
                                       formControlName="ended_at"
                                       dateFormat="dd.mm.yy"
                                       [showClear]="true"
                                       [appendTo]="'body'"
                                       [showTime]="true"
                                       [hourFormat]="'24'"
                                       [maxDate]="maxDate" />
                        <label for="ended_at">Конец сброса</label>
                    </p-floatlabel>
                </div>
            </div>
            @if (waterDischargeForm.errors?.['dateRange'] && (submitted || waterDischargeForm.controls['ended_at'].dirty)) {
                <p-message severity="error" variant="simple" size="small" class="block -mt-2 mb-3">
                    Конечная дата не может быть раньше начальной
                </p-message>
            }

            <p-floatlabel class="w-full my-4" variant="on">
                <p-input-number class="w-full"
                                inputId="flow_rate"
                                [invalid]="submitted && waterDischargeForm.controls['flow_rate'].invalid"
                                formControlName="flow_rate" />
                <label for="flow_rate">Расход, м³/с</label>
            </p-floatlabel>

            @if (submitted && waterDischargeForm.controls['flow_rate'].errors?.['required']) {
                <p-message severity="error" variant="simple" size="small">Укажите поток.</p-message>
            }
            @if (submitted && waterDischargeForm.controls['flow_rate'].errors?.['min']) {
                <p-message severity="error" variant="simple" size="small">Поток не может быть отрицательным.</p-message>
            }

            <p-floatlabel class="w-full my-4" variant="on">
        <textarea pInputTextarea
                  id="reason"
                  formControlName="reason"
                  class="w-full"
                  [autoResize]="true"
                  rows="3"></textarea>
                <label for="reason">Причина (обоснование)</label>
            </p-floatlabel>
        </form>
    </ng-template>

    <ng-template pTemplate="footer">
        <p-button label="Отмена" (click)="closeDialog()" styleClass="p-button-text" />
        <p-button label="Сохранить" type="submit" (click)="onSubmit()" />
    </ng-template>
</p-dialog>

