<div class="card">
    <div class="flex justify-center mb-4">
        <h2 class="text-2xl font-bold m-0">{{ 'SITUATION_CENTER.DISCHARGE.TITLE' | translate }}</h2>
    </div>
    <div class="flex justify-end mb-6">
        <div class="flex items-center gap-2">
            <label for="dateSelector" class="font-medium">{{ 'SITUATION_CENTER.COMMON.DATE' | translate }}:</label>
            <p-date-picker
                inputId="dateSelector"
                [(ngModel)]="selectedDate"
                [maxDate]="maxDate"
                dateFormat="dd.mm.yy"
                [showIcon]="true"
                (onSelect)="onDateChange()"
                [placeholder]="'SITUATION_CENTER.COMMON.SELECT_DATE' | translate"
            ></p-date-picker>
        </div>
    </div>
    <p-table
        [value]="dischargeByCascades"
        dataKey="id"
        stripedRows
        [loading]="loading"
        [scrollable]="true"
        scrollHeight="60vh"
        [expandedRowKeys]="expandedRows"
        [tableStyle]="{ 'min-width': '60rem' }"
    >
        <ng-template pTemplate="caption">
            <div class="flex justify-end items-center gap-2">
                <button pButton (click)="expandAll()">
                    <i pButtonIcon class="pi pi-fw"
                       [ngClass]="{ 'pi-minus': isExpanded, 'pi-plus': !isExpanded }"></i>
                    <span pButtonLabel>{{ isExpanded ? ('SITUATION_CENTER.COMMON.COLLAPSE' | translate) : ('SITUATION_CENTER.COMMON.EXPAND' | translate) }}</span>
                </button>
                <button pButton (click)="exportExcel()" icon="pi pi-file-excel" [label]="'SITUATION_CENTER.COMMON.EXPORT_EXCEL' | translate"></button>
                @if (authService.isSc()) {
                    <button pButton (click)="openDialog()">
                        <i pButtonIcon class="pi pi-plus"></i>
                        <span pButtonLabel>{{ 'SITUATION_CENTER.COMMON.ADD' | translate }}</span>
                    </button>
                }
            </div>
        </ng-template>

        <ng-template pTemplate="header">
            <tr>
                <th style="width: 3rem"></th>
                <th pSortableColumn="name">{{ 'SITUATION_CENTER.DISCHARGE.CASCADE_NAME' | translate }}
                    <p-sortIcon field="name" />
                </th>
                <th pSortableColumn="total_volume">{{ 'SITUATION_CENTER.DISCHARGE.TOTAL_CASCADE_VOLUME' | translate }}
                    <p-sortIcon field="total_volume" />
                </th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-cascade let-expanded="expanded">
            <tr>
                <td>
                    <p-button type="button" pRipple [pRowToggler]="cascade" [text]="true"
                              [rounded]="true"
                              [plain]="true"
                              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                </td>
                <td class="font-bold">{{ cascade.name }}</td>
                <td class="font-bold">{{ cascade.total_volume | number: '1.2-2' }} млн. м³</td>
            </tr>
        </ng-template>

        <ng-template pTemplate="expandedrow" let-cascade>
            <tr>
                <td colspan="3">
                    <div class="p-3">
                        <p-table [value]="cascade.hpps" dataKey="id" [expandedRowKeys]="expandedRows">
                            <ng-template #header>
                                <tr>
                                    <th style="width: 3rem"></th>
                                    <th pSortableColumn="name">{{ 'SITUATION_CENTER.DISCHARGE.GES_NAME' | translate }}
                                        <p-sortIcon field="name" />
                                    </th>
                                    <th pSortableColumn="total_volume">{{ 'SITUATION_CENTER.DISCHARGE.GES_VOLUME' | translate }}
                                        <p-sortIcon field="total_volume" />
                                    </th>
                                </tr>
                            </ng-template>
                            <ng-template #body let-hpp let-expandedHpp="expanded">
                                <tr>
                                    <td>
                                        <p-button type="button" pRipple [pRowToggler]="hpp" [text]="true"
                                                  [rounded]="true"
                                                  [plain]="true"
                                                  [icon]="expandedHpp ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                                    </td>
                                    <td>{{ hpp.name }}</td>
                                    <td>{{ hpp.total_volume | number: '1.2-2' }} млн. м³</td>
                                </tr>
                            </ng-template>

                            <ng-template pTemplate="expandedrow" let-hpp>
                                <tr>
                                    <td colspan="3">
                                        <div class="p-2">
                                            <p-table [value]="hpp.discharges" dataKey="id" class="p-datatable-sm">
                                                <ng-template #header>
                                                    <tr>
                                                        <th pSortableColumn="started_at">{{ 'SITUATION_CENTER.COMMON.START' | translate }}</th>
                                                        <th pSortableColumn="ended_at">{{ 'SITUATION_CENTER.COMMON.END' | translate }}</th>
                                                        <th pSortableColumn="flow_rate">{{ 'SITUATION_CENTER.DISCHARGE.FLOW_RATE' | translate }}</th>
                                                        <th pSortableColumn="total_volume">{{ 'SITUATION_CENTER.DISCHARGE.VOLUME' | translate }}</th>
                                                        <th pSortableColumn="reason">{{ 'SITUATION_CENTER.COMMON.REASON' | translate }}</th>
                                                        @if (authService.isSc()) {
                                                            <th pSortableColumn="created_by.name">{{ 'SITUATION_CENTER.COMMON.CREATED_BY' | translate }}</th>
                                                            <th>{{ 'SITUATION_CENTER.DISCHARGE.CONFIRMED_BY' | translate }}</th>
                                                            <th>{{ 'SITUATION_CENTER.COMMON.ACTIONS' | translate }}</th>
                                                        }
                                                    </tr>
                                                </ng-template>
                                                <ng-template #body let-discharge>
                                                    <tr>
                                                        <td>{{ discharge.started_at | date:'dd.MM.yyyy HH:mm' }}</td>
                                                        <td>{{ discharge.ended_at ? (discharge.ended_at | date:'dd.MM.yyyy HH:mm') : '-' }}</td>
                                                        <td>{{ discharge.flow_rate | number: '1.0-2' }}</td>
                                                        <td>{{ discharge.total_volume | number: '1.2-2' }}</td>
                                                        <td>{{ discharge.reason || '-' }}</td>
                                                        @if (authService.isSc()) {
                                                            <td>{{ discharge.created_by?.name || '-' }}</td>
                                                            <td>
                                                                @if (discharge.approved === true) {
                                                                    <i class="pi pi-check-circle text-green-500"
                                                                       [pTooltip]="'SITUATION_CENTER.COMMON.APPROVED' | translate"></i>
                                                                    <span
                                                                        class="ml-1">{{ discharge.updated_by?.name || '' }}</span>
                                                                } @else if (discharge.approved === false) {
                                                                    <i class="pi pi-times-circle text-red-500"
                                                                       [pTooltip]="'SITUATION_CENTER.COMMON.REJECTED' | translate"></i>
                                                                    <span
                                                                        class="ml-1">{{ discharge.updated_by?.name || '' }}</span>
                                                                } @else {
                                                                    <i class="pi pi-question-circle text-gray-500"
                                                                       [pTooltip]="'SITUATION_CENTER.COMMON.PENDING' | translate"></i>
                                                                }
                                                            </td>
                                                            <td>
                                                                <a href="tel:YOUR_NUMBER_HERE">
                                                                    <button pButton
                                                                            class="p-button-text p-button-info"
                                                                            [pTooltip]="'SITUATION_CENTER.COMMON.CALL' | translate">
                                                                        <i pButtonIcon class="pi pi-phone"></i>
                                                                    </button>
                                                                </a>
                                                                <button pButton
                                                                        class="p-button-text p-button-success"
                                                                        [pTooltip]="'SITUATION_CENTER.COMMON.APPROVE' | translate"
                                                                        (click)="openApprove(discharge.id)">
                                                                    <i pButtonIcon class="pi pi-check"></i>
                                                                </button>
                                                                <button pButton
                                                                        class="p-button-text p-button-warning"
                                                                        [pTooltip]="'SITUATION_CENTER.COMMON.EDIT' | translate"
                                                                        (click)="edit(discharge)">
                                                                    <i pButtonIcon class="pi pi-pencil"></i>
                                                                </button>
                                                                <button pButton
                                                                        class="p-button-text p-button-danger"
                                                                        [pTooltip]="'SITUATION_CENTER.COMMON.DELETE' | translate"
                                                                        (click)="openDelete(discharge.id)">
                                                                    <i pButtonIcon class="pi pi-trash"></i>
                                                                </button>
                                                            </td>
                                                        }
                                                    </tr>
                                                </ng-template>
                                                <ng-template #empty>
                                                    <tr>
                                                        <td [attr.colspan]="authService.isSc() ? 8 : 5">{{ 'SITUATION_CENTER.DISCHARGE.NO_DISCHARGES' | translate }}</td>
                                                    </tr>
                                                </ng-template>
                                            </p-table>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>
                            <ng-template #empty>
                                <tr>
                                    <td colspan="3">{{ 'SITUATION_CENTER.DISCHARGE.NO_GES' | translate }}</td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template #empty>
            <tr>
                <td colspan="3" class="text-center">{{ 'SITUATION_CENTER.COMMON.DATA_NOT_FOUND' | translate }}</td>
            </tr>
        </ng-template>

    </p-table>
</div>

<app-delete-confirmation
    [(visible)]="showDeleteDialog"
    (onConfirm)="doDelete()"
    [message]="'SITUATION_CENTER.DISCHARGE.DELETE_CONFIRM' | translate"
/>

<app-approve-confirmation
    [(visible)]="showApproveDialog"
    (onConfirm)="doApprove()"
/>

<app-discharge-dialog
    [(display)]="displayDialog"
    [modelToEdit]="modelToEdit"
    (save)="onSaveSuccess()"
></app-discharge-dialog>
