<!-- Header with filters and refresh -->
<div class="flex flex-wrap justify-between items-center gap-4 mb-4">
    <div class="flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2">
            <label class="text-sm text-surface-500">{{ 'GES_DETAIL.TELEMETRY.DEVICE_GROUP' | translate }}:</label>
            <p-select
                [(ngModel)]="selectedDeviceGroup"
                [options]="deviceGroups"
                optionLabel="label"
                optionValue="value"
                [placeholder]="'GES_DETAIL.TELEMETRY.ALL_GROUPS' | translate"
                [style]="{ 'min-width': '180px' }">
            </p-select>
        </div>
        <div class="flex items-center gap-2">
            <label class="text-sm text-surface-500">{{ 'GES_DETAIL.TELEMETRY.DEVICE' | translate }}:</label>
            <p-select
                [(ngModel)]="selectedDevice"
                [options]="devices"
                optionLabel="label"
                optionValue="value"
                [placeholder]="'GES_DETAIL.TELEMETRY.ALL_DEVICES' | translate"
                [style]="{ 'min-width': '180px' }">
            </p-select>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <span class="text-color-secondary text-sm">
            {{ 'DASHBOARD.LAST_UPDATED' | translate }}: {{ getTimeAgo() }}
        </span>
        <button
            pButton
            class="p-button-text p-button-sm p-button-secondary"
            (click)="refresh()"
            [disabled]="loading">
            <i class="pi pi-refresh" [class.pi-spin]="loading"></i>
        </button>
    </div>
</div>

<!-- Table -->
<p-table
    #dt
    [value]="filteredData"
    [loading]="loading"
    [globalFilterFields]="['deviceName', 'deviceGroup', 'name', 'value']"
    [scrollable]="true"
    scrollHeight="500px"
    [sortField]="'timestamp'"
    [sortOrder]="-1"
    styleClass="p-datatable-sm p-datatable-gridlines">

    <ng-template pTemplate="caption">
        <div class="flex justify-end items-center">
            <p-iconfield iconPosition="left">
                <p-inputicon>
                    <i class="pi pi-search"></i>
                </p-inputicon>
                <input
                    pInputText
                    type="text"
                    [(ngModel)]="searchValue"
                    (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                    [placeholder]="'COMMON.SEARCH' | translate"
                    class="w-full" />
            </p-iconfield>
            @if (searchValue) {
                <button
                    type="button"
                    class="ml-2"
                    pButton
                    severity="secondary"
                    [outlined]="true"
                    (click)="clear(dt)"
                    [pTooltip]="'COMMON.CLEAR' | translate">
                    <i pButtonIcon class="pi pi-times"></i>
                </button>
            }
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="deviceName" style="min-width: 150px">
                {{ 'GES_DETAIL.TELEMETRY.DEVICE' | translate }}
                <p-sortIcon field="deviceName"></p-sortIcon>
            </th>
            <th pSortableColumn="deviceGroup" style="min-width: 120px">
                {{ 'GES_DETAIL.TELEMETRY.GROUP' | translate }}
                <p-sortIcon field="deviceGroup"></p-sortIcon>
            </th>
            <th pSortableColumn="name" style="min-width: 150px">
                {{ 'GES_DETAIL.TELEMETRY.PARAMETER' | translate }}
                <p-sortIcon field="name"></p-sortIcon>
            </th>
            <th pSortableColumn="value" style="min-width: 120px">
                {{ 'GES_DETAIL.TELEMETRY.VALUE' | translate }}
                <p-sortIcon field="value"></p-sortIcon>
            </th>
            <th style="width: 100px">{{ 'GES_DETAIL.TELEMETRY.UNIT' | translate }}</th>
            <th pSortableColumn="quality" style="width: 100px">
                {{ 'GES_DETAIL.TELEMETRY.QUALITY' | translate }}
                <p-sortIcon field="quality"></p-sortIcon>
            </th>
            <th pSortableColumn="severity" style="width: 100px">
                {{ 'GES_DETAIL.TELEMETRY.SEVERITY' | translate }}
                <p-sortIcon field="severity"></p-sortIcon>
            </th>
            <th pSortableColumn="timestamp" style="min-width: 150px">
                {{ 'GES_DETAIL.TELEMETRY.TIMESTAMP' | translate }}
                <p-sortIcon field="timestamp"></p-sortIcon>
            </th>
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
        <tr>
            <td>{{ row.deviceName }}</td>
            <td>{{ row.deviceGroup || '—' }}</td>
            <td>{{ row.name }}</td>
            <td class="font-medium">
                @if (typeof row.value === 'number') {
                    {{ row.value | number:'1.0-2' }}
                } @else {
                    {{ row.value }}
                }
            </td>
            <td>{{ row.unit || '—' }}</td>
            <td>
                <p-tag
                    [value]="row.quality"
                    [severity]="getQualitySeverity(row.quality)">
                </p-tag>
            </td>
            <td>
                @if (row.severity) {
                    <p-tag
                        [value]="row.severity"
                        [severity]="getSeverityClass(row.severity)">
                    </p-tag>
                } @else {
                    <span class="text-surface-400">—</span>
                }
            </td>
            <td>{{ row.timestamp | date:'HH:mm:ss dd.MM.yyyy' }}</td>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="8" class="text-center py-8">
                <div class="text-surface-500">
                    <i class="pi pi-chart-line text-4xl mb-3 block opacity-50"></i>
                    <div>{{ 'GES_DETAIL.TELEMETRY.NO_DATA' | translate }}</div>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="summary">
        <div class="text-surface-500 text-sm">
            {{ 'GES_DETAIL.TELEMETRY.TOTAL_RECORDS' | translate }}: {{ filteredData.length }}
        </div>
    </ng-template>
</p-table>
