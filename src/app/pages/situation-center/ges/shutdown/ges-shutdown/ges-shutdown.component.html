@if (authService.isSc()) {
    <div class="mb-6">
        <p-button [label]="'SITUATION_CENTER.SHUTDOWN.ADD_EMERGENCY_SHUTDOWN' | translate" icon="pi pi-plus" (click)="openNew()" />
    </div>
}

<p-table
    [value]="shutdowns.ges"
    dataKey="id"
    stripedRows
    [loading]="loading"
    [scrollable]="true"
    scrollHeight="60rem"
    [tableStyle]="{ 'min-width': '60rem' }"
    [sortField]="'incident_date'"
    [sortOrder]="-1"
>
    <ng-template #caption>
        <div class="text-lg font-bold">{{ 'SITUATION_CENTER.SHUTDOWN.GES_EMERGENCY_TITLE' | translate }}</div>
    </ng-template>
    <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="organization_name">
                {{ 'SITUATION_CENTER.SHUTDOWN.GES_NAME' | translate }}
                <p-sortIcon field="organization_name"></p-sortIcon>
            </th>

            <th pSortableColumn="started_at">
                {{ 'SITUATION_CENTER.SHUTDOWN.START' | translate }}
                <p-sortIcon field="started_at"></p-sortIcon>
            </th>

            <th pSortableColumn="ended_at">
                {{ 'SITUATION_CENTER.SHUTDOWN.END' | translate }}
                <p-sortIcon field="ended_at"></p-sortIcon>
            </th>

            <th pSortableColumn="reason">
                {{ 'SITUATION_CENTER.SHUTDOWN.REASON' | translate }}
                <p-sortIcon field="reason"></p-sortIcon>
            </th>

            <th pSortableColumn="generation_loss">
                {{ 'SITUATION_CENTER.SHUTDOWN.POWER_LOSS' | translate }}
                <p-sortIcon field="generation_loss"></p-sortIcon>
            </th>
            <th pSortableColumn="idle_discharge_voleme">
                {{ 'SITUATION_CENTER.SHUTDOWN.IDLE_DISCHARGE' | translate }}
                <p-sortIcon field="idle_discharge_voleme"></p-sortIcon>
            </th>

            <th pSortableColumn="created_by.name">
                {{ 'SITUATION_CENTER.COMMON.CREATED_BY' | translate }}
                <p-sortIcon field="created_by.name"></p-sortIcon>
            </th>

            <th style="width: 10%">
                {{ 'SITUATION_CENTER.COMMON.FILES' | translate }}
            </th>

            @if (authService.isSc()) {
                <th style="width: 10%">{{ 'SITUATION_CENTER.COMMON.ACTIONS' | translate }}</th>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-shutdown>
        <tr>
            <td>
                {{ shutdown.organization_name }}
            </td>
            <td>
                {{ shutdown.started_at | date: 'HH:mm dd.MM.yyyy' }}
            </td>
            <td>
                {{ shutdown.ended_at | date: 'HH:mm dd.MM.yyyy' }}
            </td>
            <td>
                {{ shutdown.reason }}
            </td>
            <td>
                {{ shutdown.generation_loss }}
            </td>
            <td>
                {{ shutdown.idle_discharge_volume | number: '1.0-2' }}
            </td>
            <td>
                {{ shutdown.created_by?.name }}
            </td>
            <td>
                @if (shutdown.files && shutdown.files.length > 0) {
                    <p-button
                        [label]="shutdown.files.length.toString()"
                        icon="pi pi-paperclip"
                        severity="secondary"
                        [text]="true"
                        (click)="showFiles(shutdown)"
                        [pTooltip]="'SITUATION_CENTER.COMMON.VIEW_FILES' | translate"
                    />
                } @else {
                    <span class="text-color-secondary">—</span>
                }
            </td>
            @if (authService.isSc()) {
                <td>
                    <p-button
                        icon="pi pi-pencil"
                        severity="info"
                        [text]="true"
                        [rounded]="true"
                        (click)="editShutdown(shutdown)"
                        [pTooltip]="'SITUATION_CENTER.COMMON.EDIT' | translate"
                    />
                    <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        [text]="true"
                        [rounded]="true"
                        (click)="deleteShutdown(shutdown.id)"
                        [pTooltip]="'SITUATION_CENTER.COMMON.DELETE' | translate"
                    />
                </td>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td [attr.colspan]="authService.isSc() ? 9 : 8" class="text-center">
                {{ 'SITUATION_CENTER.SHUTDOWN.NO_EMERGENCY_SHUTDOWNS' | translate }}
            </td>
        </tr>
    </ng-template>

</p-table>

<div class="my-8"></div>
<hr>

<p-table
    [value]="shutdowns.micro"
    dataKey="id"
    stripedRows
    [loading]="loading"
    [scrollable]="true"
    scrollHeight="60rem"
    [tableStyle]="{ 'min-width': '60rem' }"
    [sortField]="'incident_date'"
    [sortOrder]="-1"
>
    <ng-template #caption>
        <div class="text-lg font-bold">{{ 'SITUATION_CENTER.SHUTDOWN.MICRO_GES_EMERGENCY_TITLE' | translate }}</div>
    </ng-template>
    <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="organization_name">
                {{ 'SITUATION_CENTER.SHUTDOWN.GES_NAME' | translate }}
                <p-sortIcon field="organization_name"></p-sortIcon>
            </th>

            <th pSortableColumn="started_at">
                {{ 'SITUATION_CENTER.SHUTDOWN.START' | translate }}
                <p-sortIcon field="started_at"></p-sortIcon>
            </th>

            <th pSortableColumn="ended_at">
                {{ 'SITUATION_CENTER.SHUTDOWN.END' | translate }}
                <p-sortIcon field="ended_at"></p-sortIcon>
            </th>

            <th pSortableColumn="reason">
                {{ 'SITUATION_CENTER.SHUTDOWN.REASON' | translate }}
                <p-sortIcon field="reason"></p-sortIcon>
            </th>

            <th pSortableColumn="generation_loss">
                {{ 'SITUATION_CENTER.SHUTDOWN.POWER_LOSS' | translate }}
                <p-sortIcon field="generation_loss"></p-sortIcon>
            </th>
            <th pSortableColumn="idle_discharge_voleme">
                {{ 'SITUATION_CENTER.SHUTDOWN.IDLE_DISCHARGE' | translate }}
                <p-sortIcon field="idle_discharge_voleme"></p-sortIcon>
            </th>

            <th pSortableColumn="created_by.name">
                {{ 'SITUATION_CENTER.COMMON.CREATED_BY' | translate }}
                <p-sortIcon field="created_by.name"></p-sortIcon>
            </th>

            <th style="width: 10%">
                {{ 'SITUATION_CENTER.COMMON.FILES' | translate }}
            </th>

            @if (authService.isSc()) {
                <th style="width: 10%">{{ 'SITUATION_CENTER.COMMON.ACTIONS' | translate }}</th>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-shutdown>
        <tr>
            <td>
                {{ shutdown.organization_name }}
            </td>
            <td>
                {{ shutdown.started_at | date: 'HH:mm dd.MM.yyyy' }}
            </td>
            <td>
                {{ shutdown.ended_at | date: 'HH:mm dd.MM.yyyy' }}
            </td>
            <td>
                {{ shutdown.reason }}
            </td>
            <td>
                {{ shutdown.generation_loss }}
            </td>
            <td>
                {{ shutdown.idle_discharge_volume | number: '1.0-2' }}
            </td>
            <td>
                {{ shutdown.created_by?.name }}
            </td>
            <td>
                @if (shutdown.files && shutdown.files.length > 0) {
                    <p-button
                        [label]="shutdown.files.length.toString()"
                        icon="pi pi-paperclip"
                        severity="secondary"
                        [text]="true"
                        (click)="showFiles(shutdown)"
                        [pTooltip]="'SITUATION_CENTER.COMMON.VIEW_FILES' | translate"
                    />
                } @else {
                    <span class="text-color-secondary">—</span>
                }
            </td>
            @if (authService.isSc()) {
                <td>
                    <p-button
                        icon="pi pi-pencil"
                        severity="info"
                        [text]="true"
                        [rounded]="true"
                        (click)="editShutdown(shutdown)"
                        [pTooltip]="'SITUATION_CENTER.COMMON.EDIT' | translate"
                    />
                    <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        [text]="true"
                        [rounded]="true"
                        (click)="deleteShutdown(shutdown.id)"
                        [pTooltip]="'SITUATION_CENTER.COMMON.DELETE' | translate"
                    />
                </td>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td [attr.colspan]="authService.isSc() ? 9 : 8" class="text-center">
                {{ 'SITUATION_CENTER.SHUTDOWN.NO_EMERGENCY_SHUTDOWNS' | translate }}
            </td>
        </tr>
    </ng-template>

</p-table>

<div class="my-8"></div>
<hr>

<p-table
    [value]="shutdowns.mini"
    dataKey="id"
    stripedRows
    [loading]="loading"
    [scrollable]="true"
    scrollHeight="60rem"
    [tableStyle]="{ 'min-width': '60rem' }"
    [sortField]="'incident_date'"
    [sortOrder]="-1"
>
    <ng-template #caption>
        <div class="text-lg font-bold">{{ 'SITUATION_CENTER.SHUTDOWN.MINI_GES_EMERGENCY_TITLE' | translate }}</div>
    </ng-template>
    <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="organization_name">
                {{ 'SITUATION_CENTER.SHUTDOWN.GES_NAME' | translate }}
                <p-sortIcon field="organization_name"></p-sortIcon>
            </th>

            <th pSortableColumn="started_at">
                {{ 'SITUATION_CENTER.SHUTDOWN.START' | translate }}
                <p-sortIcon field="started_at"></p-sortIcon>
            </th>

            <th pSortableColumn="ended_at">
                {{ 'SITUATION_CENTER.SHUTDOWN.END' | translate }}
                <p-sortIcon field="ended_at"></p-sortIcon>
            </th>

            <th pSortableColumn="reason">
                {{ 'SITUATION_CENTER.SHUTDOWN.REASON' | translate }}
                <p-sortIcon field="reason"></p-sortIcon>
            </th>

            <th pSortableColumn="generation_loss">
                {{ 'SITUATION_CENTER.SHUTDOWN.POWER_LOSS' | translate }}
                <p-sortIcon field="generation_loss"></p-sortIcon>
            </th>
            <th pSortableColumn="idle_discharge_voleme">
                {{ 'SITUATION_CENTER.SHUTDOWN.IDLE_DISCHARGE' | translate }}
                <p-sortIcon field="idle_discharge_voleme"></p-sortIcon>
            </th>

            <th pSortableColumn="created_by.name">
                {{ 'SITUATION_CENTER.COMMON.CREATED_BY' | translate }}
                <p-sortIcon field="created_by.name"></p-sortIcon>
            </th>

            <th style="width: 10%">
                {{ 'SITUATION_CENTER.COMMON.FILES' | translate }}
            </th>

            @if (authService.isSc()) {
                <th style="width: 10%">{{ 'SITUATION_CENTER.COMMON.ACTIONS' | translate }}</th>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-shutdown>
        <tr>
            <td>
                {{ shutdown.organization_name }}
            </td>
            <td>
                {{ shutdown.started_at | date: 'HH:mm dd.MM.yyyy' }}
            </td>
            <td>
                {{ shutdown.ended_at | date: 'HH:mm dd.MM.yyyy' }}
            </td>
            <td>
                {{ shutdown.reason }}
            </td>
            <td>
                {{ shutdown.generation_loss }}
            </td>
            <td>
                {{ shutdown.idle_discharge_volume | number: '1.0-2' }}
            </td>
            <td>
                {{ shutdown.created_by?.name }}
            </td>
            <td>
                @if (shutdown.files && shutdown.files.length > 0) {
                    <p-button
                        [label]="shutdown.files.length.toString()"
                        icon="pi pi-paperclip"
                        severity="secondary"
                        [text]="true"
                        (click)="showFiles(shutdown)"
                        [pTooltip]="'SITUATION_CENTER.COMMON.VIEW_FILES' | translate"
                    />
                } @else {
                    <span class="text-color-secondary">—</span>
                }
            </td>
            @if (authService.isSc()) {
                <td>
                    <p-button
                        icon="pi pi-pencil"
                        severity="info"
                        [text]="true"
                        [rounded]="true"
                        (click)="editShutdown(shutdown)"
                        [pTooltip]="'SITUATION_CENTER.COMMON.EDIT' | translate"
                    />
                    <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        [text]="true"
                        [rounded]="true"
                        (click)="deleteShutdown(shutdown.id)"
                        [pTooltip]="'SITUATION_CENTER.COMMON.DELETE' | translate"
                    />
                </td>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td [attr.colspan]="authService.isSc() ? 9 : 8" class="text-center">
                {{ 'SITUATION_CENTER.SHUTDOWN.NO_EMERGENCY_SHUTDOWNS' | translate }}
            </td>
        </tr>
    </ng-template>

</p-table>

<app-dialog
    [(visible)]="isFormOpen"
    [header]="isEditMode ? ('SITUATION_CENTER.SHUTDOWN.EDIT_EVENT' | translate) : ('SITUATION_CENTER.SHUTDOWN.NEW_EVENT' | translate)"
    [form]="form"
    [submitting]="isLoading"
    (save)="onSubmit()"
    (cancel)="closeDialog()"
>
    <form class="p-4" [formGroup]="form" (ngSubmit)="onSubmit()">

        <app-group-select
            [label]="'SITUATION_CENTER.COMMON.OBJECT' | translate"
            formControlName="organization"
            [items]="organizations"
            [loading]="orgsLoading"
            [submitted]="submitted"
            [errorMessage]="'SITUATION_CENTER.COMMON.SELECT_ORGANIZATION' | translate">
        </app-group-select>

        <app-date-picker
            [label]="'SITUATION_CENTER.SHUTDOWN.EMERGENCY_START' | translate"
            formControlName="start_time"
            [submitted]="submitted"
            [errorMessage]="'SITUATION_CENTER.COMMON.SPECIFY_DATE' | translate">
        </app-date-picker>

        <app-date-picker
            [label]="'SITUATION_CENTER.SHUTDOWN.EMERGENCY_END' | translate"
            formControlName="end_time"
            [submitted]="submitted"
            [required]="false">
        </app-date-picker>

        <app-textarea
            [label]="'SITUATION_CENTER.SHUTDOWN.REASON' | translate"
            formControlName="reason"
            [submitted]="submitted"
            [required]="false">
        </app-textarea>

        <app-input-number
            [label]="'SITUATION_CENTER.SHUTDOWN.LOST_POWER' | translate"
            formControlName="generation_loss"
            [submitted]="submitted"
            [required]="false">
        </app-input-number>

        <app-input-number
            [label]="'SITUATION_CENTER.SHUTDOWN.IDLE_DISCHARGE' | translate"
            formControlName="idle_discharge_volume"
            [submitted]="submitted"
            [required]="false">
        </app-input-number>

        @if (isEditMode && currentShutdown?.files && (currentShutdown?.files?.length ?? 0) > 0) {
            <app-file-list
                [files]="currentShutdown?.files || []"
                (removeFile)="removeExistingFile($event)">
            </app-file-list>
        }

        <app-file-upload
            [label]="isEditMode ? ('SITUATION_CENTER.COMMON.ADD_NEW_FILES' | translate) : ('SITUATION_CENTER.COMMON.ATTACH_FILES' | translate)"
            [files]="selectedFiles"
            (filesChange)="onFileSelect($event)"
            (removeFile)="removeFile($event)">
        </app-file-upload>

    </form>

</app-dialog>

<app-file-viewer
    [(visible)]="showFilesDialog"
    [header]="'SITUATION_CENTER.SHUTDOWN.EVENT_FILES' | translate"
    [files]="selectedShutdownForFiles?.files || []">
</app-file-viewer>
