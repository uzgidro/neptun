@if (authService.isSc()) {
    <div class="mb-6">
        <p-button label="Добавить водосброс" icon="pi pi-plus" (click)="openNew()" />
    </div>
}

<p-table
    #shd
    class="mt-6"
    [value]="discharges"
    dataKey="id"
    [loading]="loading"
    [scrollable]="true"
    scrollHeight="60rem"
    [tableStyle]="{ 'min-width': '60rem' }"
    rowGroupMode="subheader"
    groupRowsBy="organization.name"
    [sortField]="'organization.name'"
    [globalFilterFields]="['organization.name', 'reason', 'created_by.name']"
>
    <ng-template #caption>
        <div class="flex justify-between items-center">
            <div class="text-lg font-bold">Холостые водосбросы</div>
            <p-iconfield>
                <p-inputicon>
                    <i class="pi pi-search"></i>
                </p-inputicon>
                <input
                    #searchInput
                    pInputText
                    type="text"
                    (input)="shd.filterGlobal(searchInput.value, 'contains')"
                    placeholder="Поиск..."
                    class="w-full"
                />
            </p-iconfield>
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="started_at" style="min-width: 12rem">
                <div class="flex items-center gap-2">
                    Начало
                    <p-sortIcon field="started_at" />
                    <p-columnFilter type="date" field="started_at" display="menu" />
                </div>
            </th>
            <th pSortableColumn="ended_at" style="min-width: 12rem">
                <div class="flex items-center gap-2">
                    Конец
                    <p-sortIcon field="ended_at" />
                    <p-columnFilter type="date" field="ended_at" display="menu" />
                </div>
            </th>
            <th pSortableColumn="flow_rate" style="min-width: 10rem">
                <div class="flex items-center gap-2">
                    Поток, м³/с
                    <p-sortIcon field="flow_rate" />
                    <p-columnFilter type="numeric" field="flow_rate" display="menu" />
                </div>
            </th>
            <th pSortableColumn="total_volume" style="min-width: 10rem">
                <div class="flex items-center gap-2">
                    Объём, млн. м³
                    <p-sortIcon field="total_volume" />
                    <p-columnFilter type="numeric" field="total_volume" display="menu" />
                </div>
            </th>
            <th pSortableColumn="reason" style="min-width: 12rem">
                <div class="flex items-center gap-2">
                    Причина
                    <p-sortIcon field="reason" />
                    <p-columnFilter type="text" field="reason" display="menu" />
                </div>
            </th>
            <th pSortableColumn="created_by.name" style="min-width: 10rem">
                <div class="flex items-center gap-2">
                    Создал
                    <p-sortIcon field="created_by.name" />
                    <p-columnFilter type="text" field="created_by.name" display="menu" />
                </div>
            </th>
            <th style="width: 10%">Файлы</th>
            @if (authService.isSc()) {
                <th style="width: 10%">Действия</th>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="groupheader" let-discharge>
        <tr>
            <td class="bg-gray-200 dark:bg-gray-900" colspan="2">
                <span class="font-bold text-lg">{{ discharge.organization.name }}</span>
            </td>
            <td class="bg-gray-200 dark:bg-gray-900 font-semibold">
                {{ getAverageFlowRate(discharge.organization.name) | number: '1.0-2' }}
            </td>
            <td class="bg-gray-200 dark:bg-gray-900 font-semibold">
                {{ getTotalVolume(discharge.organization.name) | number: '1.0-2' }}
            </td>
            <td class="bg-gray-200 dark:bg-gray-900" colspan="3"></td>
            @if (authService.isSc()) {
                <td class="bg-gray-200 dark:bg-gray-900"></td>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-discharge>
        <tr>
            <td>{{ discharge.started_at | date:'dd.MM.yyyy HH:mm' }}</td>
            <td>{{ discharge.ended_at ? (discharge.ended_at | date:'dd.MM.yyyy HH:mm') : '-' }}</td>
            <td>{{ discharge.flow_rate | number: '1.0-2' }}</td>
            <td>{{ discharge.total_volume | number: '1.2-2' }}</td>
            <td>{{ discharge.reason || '-' }}</td>
            <td>{{ discharge.created_by?.name }}</td>
            <td>
                @if (discharge.files && discharge.files.length > 0) {
                    <p-button
                        [label]="discharge.files.length.toString()"
                        icon="pi pi-paperclip"
                        severity="secondary"
                        [text]="true"
                        (click)="showFiles(discharge)"
                        pTooltip="Просмотр файлов"
                    />
                } @else {
                    <span class="text-color-secondary">—</span>
                }
            </td>
            @if (authService.isSc()) {
                <td>
                    <p-button
                        icon="pi pi-pencil"
                        severity="info"
                        [text]="true"
                        [rounded]="true"
                        (click)="editDischarge(discharge)"
                        pTooltip="Редактировать"
                    />
                    <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        [text]="true"
                        [rounded]="true"
                        (click)="deleteDischarge(discharge)"
                        pTooltip="Удалить"
                    />
                </td>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td [attr.colspan]="authService.isSc() ? 8 : 7" class="text-center">
                Водосбросы за выбранную дату не найдены.
            </td>
        </tr>
    </ng-template>

</p-table>

<app-dialog
    [(visible)]="isFormOpen"
    [header]="isEditMode ? 'Редактировать Водосброс' : 'Новый Водосброс'"
    [form]="form"
    [submitting]="isLoading"
    (save)="onSubmit()"
    (cancel)="closeDialog()"
>
    <form class="p-4" [formGroup]="form" (ngSubmit)="onSubmit()">

        <app-select
            label="Объект"
            formControlName="organization"
            [items]="organizations"
            [loading]="orgsLoading"
            [submitted]="submitted"
            errorMessage="Выберите организацию">
        </app-select>

        <app-date-picker
            label="Начало водосброса"
            formControlName="started_at"
            [submitted]="submitted"
            errorMessage="Укажите дату начала">
        </app-date-picker>

        <app-date-picker
            label="Конец водосброса"
            formControlName="ended_at"
            [submitted]="submitted"
            [required]="false">
        </app-date-picker>

        <app-input-number
            label="Поток, м³/с"
            formControlName="flow_rate"
            [submitted]="submitted"
            errorMessage="Укажите значение потока">
        </app-input-number>

        <app-textarea
            label="Причина"
            formControlName="reason"
            [submitted]="submitted"
            [required]="false">
        </app-textarea>

        @if (isEditMode && currentDischarge?.files && (currentDischarge?.files?.length ?? 0) > 0) {
            <app-file-list
                [files]="currentDischarge?.files || []"
                (removeFile)="removeExistingFile($event)">
            </app-file-list>
        }

        <app-file-upload
            [label]="isEditMode ? 'Добавить новые файлы' : 'Прикрепить файлы'"
            [files]="selectedFiles"
            (filesChange)="onFileSelect($event)"
            (removeFile)="removeFile($event)">
        </app-file-upload>

    </form>

</app-dialog>

<app-file-viewer
    [(visible)]="showFilesDialog"
    [header]="'Файлы водосброса'"
    [files]="selectedDischargeForFiles?.files || []">
</app-file-viewer>
