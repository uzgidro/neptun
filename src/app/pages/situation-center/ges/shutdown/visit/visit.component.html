@if (authService.isSc()) {
    <div class="mb-6">
        <p-button label="Создать Визит" icon="pi pi-plus" (click)="openNew()" />
    </div>
}

<p-table
    [value]="visits"
    dataKey="id"
    stripedRows
    [loading]="loading"
    [scrollable]="true"
    scrollHeight="60rem"
    [tableStyle]="{ 'min-width': '60rem' }"
    [sortField]="'visit_date'"
    [sortOrder]="-1"
>
    <ng-template #caption>
        <div class="text-lg font-bold">Визиты - Посещения</div>
    </ng-template>
    <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="visit_date">
                Дата визита <p-sortIcon field="visit_date"></p-sortIcon>
            </th>

            <th pSortableColumn="organization_name">
                Название объекта <p-sortIcon field="organization_name"></p-sortIcon>
            </th>

            <th>
                Описание
            </th>

            <th pSortableColumn="responsible_name">
                Ответственный <p-sortIcon field="responsible_name"></p-sortIcon>
            </th>

            <th pSortableColumn="created_by_user">
                Создал
                <p-sortIcon field="created_by_user"></p-sortIcon>
            </th>

            <th style="width: 10%">
                Файлы
            </th>

            @if (authService.isSc()) {
                <th style="width: 10%">
                    Действия
                </th>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-visit>
        <tr>
            <td>
                {{ visit.visit_date | date: 'dd.MM.yyyy HH:mm' }}
            </td>
            <td>
                {{ visit.organization_name }}
            </td>
            <td>
                {{ visit.description }}
            </td>
            <td>
                {{ visit.responsible_name }}
            </td>
            <td>
                {{ visit.created_by?.name }}
            </td>
            <td>
                @if (visit.files && visit.files.length > 0) {
                    <p-button
                        [label]="visit.files.length.toString()"
                        icon="pi pi-paperclip"
                        severity="secondary"
                        [text]="true"
                        (click)="showFiles(visit)"
                        pTooltip="Просмотр файлов"
                    />
                } @else {
                    <span class="text-color-secondary">—</span>
                }
            </td>
            @if (authService.isSc()) {
                <td>
                    <p-button
                        icon="pi pi-pencil"
                        severity="info"
                        [text]="true"
                        [rounded]="true"
                        (click)="editVisit(visit)"
                        pTooltip="Редактировать"
                    />
                    <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        [text]="true"
                        [rounded]="true"
                        (click)="deleteVisit(visit.id)"
                        pTooltip="Удалить"
                    />
                </td>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td [attr.colspan]="authService.isSc() ? 7 : 6" class="text-center">
                Визиты за выбранную дату не найдены.
            </td>
        </tr>
    </ng-template>

</p-table>

<app-dialog
    [(visible)]="isFormOpen"
    [header]="isEditMode ? 'Редактировать Визит' : 'Новый Визит'"
    [form]="form"
    [submitting]="isLoading"
    (save)="onSubmit()"
    (cancel)="closeDialog()"
>
    <form class="p-4" [formGroup]="form" (ngSubmit)="onSubmit()">

        <app-select
            label="Объект"
            formControlName="organization"
            [items]="organizations"
            [loading]="orgsLoading"
            [submitted]="submitted"
            errorMessage="Выберите организацию">
        </app-select>

        <app-date-picker
            label="Дата визита"
            formControlName="visit_date"
            [submitted]="submitted"
            errorMessage="Укажите дату">
        </app-date-picker>

        <app-input-text
            label="Ответственный"
            formControlName="responsible_name"
            [submitted]="submitted"
            errorMessage="Укажите ответственного">
        </app-input-text>

        <app-textarea
            label="Описание"
            formControlName="description"
            [submitted]="submitted"
            errorMessage="Укажите описание">
        </app-textarea>

        @if (isEditMode && currentVisit?.files && (currentVisit?.files?.length ?? 0) > 0) {
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Существующие файлы</label>
                <div class="flex flex-col gap-2">
                    @for (file of currentVisit?.files; track file.id) {
                        <div class="flex justify-between items-center p-2 rounded"
                             style="background-color: var(--surface-50);">
                            <div class="flex items-center gap-2">
                                <i class="pi pi-file"></i>
                                <span class="text-sm">{{ file.file_name }}</span>
                                <span class="text-sm"
                                      style="color: var(--text-color-secondary);">({{ formatFileSize(file.size_bytes) }}
                                    )</span>
                            </div>
                            <p-button
                                icon="pi pi-times"
                                [rounded]="true"
                                [text]="true"
                                severity="danger"
                                size="small"
                                (onClick)="removeExistingFile(file.id)"
                                pTooltip="Удалить файл"
                            />
                        </div>
                    }
                </div>
            </div>
        }

        <app-file-upload
            [label]="isEditMode ? 'Добавить новые файлы' : 'Прикрепить файлы'"
            [files]="selectedFiles"
            (filesChange)="onFileSelect($event)"
            (removeFile)="removeFile($event)">
        </app-file-upload>

    </form>

</app-dialog>

<app-file-viewer
    [(visible)]="showFilesDialog"
    [header]="'Файлы визита'"
    [files]="selectedVisitForFiles?.files || []">
</app-file-viewer>
