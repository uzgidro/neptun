<div class="card">
    <h3 class="text-center mb-3">Сводка по водохранилищам</h3>

    <form [formGroup]="form" class="mb-4">
        <div class="w-full md:w-1/4">
            <app-date-picker
                label="Выберите дату"
                formControlName="date"
                [showTime]="false"
                [submitted]="submitted"
                errorMessage="Укажите дату">
            </app-date-picker>
        </div>
    </form>

    @if (data) {
        <p-table
            [value]="data"
            [scrollable]="true"
            showGridlines
            stripedRows
            scrollHeight="60vh"
            [tableStyle]="{ 'min-width': '1200px' }">

            <ng-template pTemplate="header">
                <tr>
                    <th rowspan="3">Водохранилище</th>
                    <th>Уровень, м</th>
                    <th colspan="3">Объем, млн. м³</th>
                    <th colspan="3">Приток, м³/с</th>
                    <th colspan="3">Попуск, м³/с</th>
                    <th colspan="2" rowspan="2">Приток до сегодняшнего дня, млн. м³</th>
                    <th colspan="2" rowspan="2">MODSNOW, снежный покров %</th>
                </tr>
                <tr>
                    <th rowspan="2" class="text-nowrap">{{ form.get('date')?.value | date: 'dd MMM' : '' : 'ru' }}</th>
                    <th rowspan="2" class="text-nowrap">{{ form.get('date')?.value | date: 'dd MMM' : '' : 'ru' }}</th>
                    <th colspan="2">Прошлые года</th>
                    <th rowspan="2" class="text-nowrap">{{ form.get('date')?.value | date: 'dd MMM' : '' : 'ru' }}</th>
                    <th colspan="2">Прошлые года</th>
                    <th rowspan="2" class="text-nowrap">{{ form.get('date')?.value | date: 'dd MMM' : '' : 'ru' }}</th>
                    <th colspan="2">Прошлые года</th>
                </tr>
                <tr>
                    <th>{{ getPreviousYear(1) }}</th>
                    <th>{{ getPreviousYear(2) }}</th>
                    <th>{{ getPreviousYear(1) }}</th>
                    <th>{{ getPreviousYear(2) }}</th>
                    <th>{{ getPreviousYear(1) }}</th>
                    <th>{{ getPreviousYear(2) }}</th>
                    <th>{{ form.get('date')?.value | date: 'yyyy' }}</th>
                    <th>{{ getPreviousYear(1) }}</th>
                    <th>{{ form.get('date')?.value | date: 'yyyy' }}</th>
                    <th>{{ getPreviousYear(1) }}</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-reservoir>
                <tr>
                    <td rowspan="2">{{ reservoir.organization_name }}</td>
                    <td [pEditableColumn]="reservoir.level" pEditableColumnField="current" class="text-nowrap">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="number" [(ngModel)]="reservoir.level.current" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ reservoir.level.current | number: '1.0-2' }}
                                <i class="pi pi-pen-to-square ml-2 text-gray-400 text-xs"></i>
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td [pEditableColumn]="reservoir.volume" pEditableColumnField="current" class="text-nowrap">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="number" [(ngModel)]="reservoir.volume.current" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ reservoir.volume.current | number: '1.0-2' }}
                                <i class="pi pi-pen-to-square ml-2 text-gray-400 text-xs"></i>
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td>{{ reservoir.volume.year_ago !== null ? (reservoir.volume.year_ago | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ reservoir.volume.two_years_ago !== null ? (reservoir.volume.two_years_ago | number: '1.0-2') : 'N/A' }}</td>
                    <td [pEditableColumn]="reservoir.income" pEditableColumnField="current" class="text-nowrap">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="number" [(ngModel)]="reservoir.income.current" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ reservoir.income.current | number: '1.0-2' }}
                                <i class="pi pi-pen-to-square ml-2 text-gray-400 text-xs"></i>
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td>{{ reservoir.income.year_ago !== null ? (reservoir.income.year_ago | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ reservoir.income.two_years_ago !== null ? (reservoir.income.two_years_ago | number: '1.0-2') : 'N/A' }}</td>
                    <td [pEditableColumn]="reservoir.release" pEditableColumnField="current" class="text-nowrap">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="number" [(ngModel)]="reservoir.release.current" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ reservoir.release.current | number: '1.0-2' }}
                                <i class="pi pi-pen-to-square ml-2 text-gray-400 text-xs"></i>
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td>{{ reservoir.release.year_ago !== null ? (reservoir.release.year_ago | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ reservoir.release.two_years_ago !== null ? (reservoir.release.two_years_ago | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ reservoir.incoming_volume | number: '1.0-2' }}</td>
                    <td>{{ reservoir.incoming_volume_prev_year | number: '1.0-2' }}</td>
                    <td>N/A</td>
                    <td>N/A</td>
                </tr>
                <tr class="italic">
                    <td>{{ reservoir.organization_id != null ? ((reservoir.level.current - reservoir.level.prev) | number: '1.0-2') : '' }}</td>
                    <td>{{ reservoir.organization_id != null ? ((reservoir.volume.current - reservoir.volume.prev) | number: '1.0-2') : '' }}</td>
                    <td>{{ reservoir.volume.year_ago !== null ? ((reservoir.volume.current - reservoir.volume.year_ago) | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ reservoir.volume.two_years_ago !== null ? ((reservoir.volume.current - reservoir.volume.two_years_ago) | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ (reservoir.income.current - reservoir.income.prev) | number: '1.0-2' }}</td>
                    <td>{{ reservoir.income.year_ago !== null ? ((reservoir.income.current - reservoir.income.year_ago) | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ reservoir.income.two_years_ago !== null ? ((reservoir.income.current - reservoir.income.two_years_ago) | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ (reservoir.release.current - reservoir.release.prev) | number: '1.0-2' }}</td>
                    <td>{{ reservoir.release.year_ago !== null ? ((reservoir.release.current - reservoir.release.year_ago) | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ reservoir.release.two_years_ago !== null ? ((reservoir.release.current - reservoir.release.two_years_ago) | number: '1.0-2') : 'N/A' }}</td>
                    <td>{{ (reservoir.incoming_volume - reservoir.incoming_volume_prev_year) | number: '1.0-2' }}</td>
                    <td>{{ ((reservoir.incoming_volume / reservoir.incoming_volume_prev_year) * 100) | number: '1.0-0' }}
                        %
                    </td>
                    <td>N/A</td>
                    <td>N/A</td>
                </tr>
            </ng-template>
        </p-table>

        @if (hasChanges()) {
            <div class="flex justify-end gap-2 mt-3">
                <button pButton type="button" class="p-button-secondary"
                        (click)="onReset()">
                    <span pButtonLabel>Сбросить</span>
                    <i pButtonIcon class="pi pi-times"></i>
                </button>
                <button pButton type="button" (click)="onAccept()">
                    <span pButtonLabel>Применить</span>
                    <i pButtonIcon class="pi pi-check"></i>
                </button>
            </div>
        }
    }
</div>
