<div class="sc-map neon-card">
    <div class="map-header">
        <div class="widget-title">
            <i class="pi pi-map title-icon"></i>
            <span>{{ 'SITUATION_CENTER.DASHBOARD.MAP.TITLE' | translate }}</span>
        </div>
    </div>

    <div class="map-content" [class.split-view]="selectedRegionId">
        <div class="map-container">
            <app-uz-map (regionClick)="onRegionClick($event)"></app-uz-map>
        </div>

        @if (selectedRegionId) {
            <div class="region-panel">
                <div class="panel-header">
                    <span class="panel-title">{{ getRegionName(selectedRegionId) }}</span>
                    <button class="close-btn" (click)="closePanel()">
                        <i class="pi pi-times"></i>
                    </button>
                </div>
                <div class="panel-body">
                    <!-- Loading State -->
                    @if (isLoadingRegionData) {
                        <div class="loading-state">
                            <i class="pi pi-spin pi-spinner"></i>
                            <span>{{ 'SITUATION_CENTER.DASHBOARD.MAP.LOADING_DATA' | translate }}</span>
                        </div>
                    }

                    <!-- No Mapping State -->
                    @if (!hasRegionMapping && !isLoadingRegionData) {
                        <div class="no-data-state">
                            <i class="pi pi-info-circle"></i>
                            <span>{{ 'SITUATION_CENTER.DASHBOARD.MAP.DATA_UNAVAILABLE' | translate }}</span>
                        </div>
                    }

                    <!-- Region Data -->
                    @if (regionData && !isLoadingRegionData) {
                        <!-- Каскады и ГЭС -->
                        @for (cascade of regionData.cascades; track cascade.id) {
                            <div class="data-section cascade-section">
                                <div class="section-header cascade-header">
                                    <div class="cascade-title">
                                        <i class="pi pi-sitemap"></i>
                                        <span>{{ cascade.name }}</span>
                                    </div>
                                    <div class="cascade-summary">
                                        <span class="cascade-power">{{ cascade.totalPower | number:'1.1-1' }} МВт</span>
                                    </div>
                                </div>
                                <div class="section-content">
                                    @for (ges of cascade.items; track ges.id) {
                                        <div class="ges-item">
                                            <div class="ges-header">
                                                <span class="ges-name">{{ ges.name }}</span>
                                                <span class="ges-power">{{ ges.ascue_metrics?.active || 0 | number:'1.1-1' }} МВт</span>
                                            </div>
                                            <div class="ges-aggregates">
                                                <span class="agg working" title="Рабочие">
                                                    <i class="pi pi-bolt"></i>
                                                    {{ ges.ascue_metrics?.active_agg_count || 0 }}
                                                </span>
                                                <span class="agg reserve" title="В резерве">
                                                    <i class="pi pi-pause-circle"></i>
                                                    {{ ges.ascue_metrics?.pending_agg_count || 0 }}
                                                </span>
                                                <span class="agg repair" title="На ремонте">
                                                    <i class="pi pi-wrench"></i>
                                                    {{ ges.ascue_metrics?.repair_agg_count || 0 }}
                                                </span>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="cascade-footer">
                                    <span class="footer-label">{{ 'SITUATION_CENTER.DASHBOARD.MAP.TOTAL_AGGREGATES' | translate }}:</span>
                                    <div class="footer-aggregates">
                                        <span class="agg working">{{ cascade.totalAggregates.active }}</span>
                                        <span class="agg reserve">{{ cascade.totalAggregates.pending }}</span>
                                        <span class="agg repair">{{ cascade.totalAggregates.repair }}</span>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Водосбросы -->
                        <div class="data-section">
                            <div class="section-header">
                                <i class="pi pi-wave-pulse"></i>
                                <span>{{ 'SITUATION_CENTER.DASHBOARD.MAP.SPILLWAY_DISCHARGES' | translate }}</span>
                            </div>
                            @if (regionData.discharges.length > 0) {
                                <div class="section-content">
                                    @for (item of regionData.discharges; track item.name) {
                                        <div class="data-row">
                                            <span class="data-name">{{ item.name }}</span>
                                            <span class="data-value discharge">{{ item.value }} {{ 'SITUATION_CENTER.DASHBOARD.UNITS.M3_S' | translate }}</span>
                                        </div>
                                    }
                                </div>
                            } @else {
                                <div class="section-empty">{{ 'SITUATION_CENTER.DASHBOARD.MAP.NO_ACTIVE_DISCHARGES' | translate }}</div>
                            }
                        </div>

                        <!-- Аварийные отключения -->
                        <div class="data-section">
                            <div class="section-header">
                                <i class="pi pi-exclamation-triangle"></i>
                                <span>{{ 'SITUATION_CENTER.DASHBOARD.MAP.EMERGENCY_SHUTDOWNS' | translate }}</span>
                            </div>
                            @if (regionData.shutdowns.length > 0) {
                                <div class="section-content">
                                    @for (shutdown of regionData.shutdowns; track shutdown.id) {
                                        <div class="shutdown-item">
                                            <div class="shutdown-name">{{ shutdown.organization_name }}</div>
                                            @if (shutdown.reason) {
                                                <div class="shutdown-reason">{{ shutdown.reason }}</div>
                                            }
                                            <div class="shutdown-time">с {{ shutdown.started_at | date:'dd.MM.yyyy HH:mm' }}</div>
                                        </div>
                                    }
                                </div>
                            } @else {
                                <div class="section-empty">{{ 'SITUATION_CENTER.DASHBOARD.MAP.NO_ACTIVE_SHUTDOWNS' | translate }}</div>
                            }
                        </div>

                        <!-- Водохранилища -->
                        <div class="data-section">
                            <div class="section-header">
                                <i class="pi pi-database"></i>
                                <span>{{ 'SITUATION_CENTER.DASHBOARD.MAP.RESERVOIRS' | translate }}</span>
                            </div>
                            @if (regionData.reservoirs.length > 0) {
                                <div class="section-content">
                                    @for (reservoir of regionData.reservoirs; track reservoir.organization_id) {
                                        <div class="reservoir-item">
                                            <div class="reservoir-name">{{ reservoir.organization_name }}</div>
                                            <div class="reservoir-metrics">
                                                <div class="metric">
                                                    <span class="metric-label">{{ 'SITUATION_CENTER.DASHBOARD.MONITORING.VOLUME' | translate }}</span>
                                                    <span class="metric-value">{{ reservoir.reservoir_metrics.current.volume | number:'1.0-0' }} {{ 'SITUATION_CENTER.DASHBOARD.UNITS.MLN_M3' | translate }}</span>
                                                </div>
                                                <div class="metric">
                                                    <span class="metric-label">{{ 'SITUATION_CENTER.DASHBOARD.MONITORING.LEVEL' | translate }}</span>
                                                    <span class="metric-value">{{ reservoir.reservoir_metrics.current.level | number:'1.2-2' }} {{ 'SITUATION_CENTER.DASHBOARD.UNITS.M' | translate }}</span>
                                                </div>
                                                <div class="metric">
                                                    <span class="metric-label">{{ 'SITUATION_CENTER.DASHBOARD.MONITORING.INFLOW' | translate }}</span>
                                                    <span class="metric-value">{{ reservoir.reservoir_metrics.current.income | number:'1.0-0' }} {{ 'SITUATION_CENTER.DASHBOARD.UNITS.M3_S' | translate }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            } @else {
                                <div class="section-empty">{{ 'SITUATION_CENTER.DASHBOARD.MAP.NO_RESERVOIRS' | translate }}</div>
                            }
                        </div>

                    }
                </div>
            </div>
        }
    </div>
</div>
